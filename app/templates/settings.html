{% extends "base.html" %}

{% block title %}Settings{% endblock %}

{% block content %}
<div class="settings-wrapper">

    <div class="header-row">
        <h1>Settings</h1>
    </div>

    <div class="settings-grid">
        
        <div class="settings-column">
            
            <div class="card panel">
                <div class="panel-header">
                    <h3>Global Configuration</h3>
                </div>
                <div class="panel-body">
                    <form onsubmit="saveSettings(event)">
                        <div class="form-group">
                            <label>Server Name</label>
                            <input type="text" id="set_server_name" placeholder="Manga Server">
                        </div>
                        <div class="form-group">
                            <label>Default Reading Direction</label>
                            <select id="set_direction">
                                <option value="LTR">Left to Right (Comic)</option>
                                <option value="RTL">Right to Left (Manga)</option>
                            </select>
                        </div>

                        <div class="form-group row-group">
                            <input type="checkbox" id="set_show_uncategorized" style="width: auto; margin: 0;">
                            <label for="set_show_uncategorized" style="margin: 0; cursor: pointer;">Show "Uncategorized" Filter</label>
                        </div>

                        <button type="submit" class="btn-save" style="margin-top: 10px;">Save Globals</button>
                    </form>
                </div>
            </div>

            <div class="card panel">
                <div class="panel-header">
                    <h3>Database & Backup</h3>
                </div>
                <div class="panel-body">
                    <div style="margin-bottom: 20px; background: #252525; padding: 10px; border-radius: 4px;">
                        <div class="form-group row-group" style="margin-bottom: 10px; background: transparent; border: none; padding: 0;">
                            <input type="checkbox" id="bk_enabled" style="width: auto; margin: 0;" onchange="toggleBackupSlider()">
                            <label for="bk_enabled" style="margin: 0; cursor: pointer; font-weight: bold; color: white;">Enable Auto-Backup</label>
                        </div>

                        <div id="bk_slider_container" style="opacity: 0.5; pointer-events: none; transition: opacity 0.2s;">
                            <label style="display: flex; justify-content: space-between; color: #aaa; font-size: 0.9rem; margin-bottom: 5px;">
                                <span>Backup Frequency</span>
                                <span id="bk_val_display" style="color: var(--accent);">7 Days</span>
                            </label>
                            <input type="range" id="bk_frequency" min="1" max="180" value="7" style="width: 100%; cursor: pointer;" 
                                   oninput="document.getElementById('bk_val_display').innerText = this.value + ' Days'">
                        </div>
                        
                        <div style="text-align: right; margin-top: 10px;">
                            <button onclick="saveBackupSettings()" class="btn-small" style="background: #2ecc71;">Save Backup Settings</button>
                        </div>
                    </div>

                    <hr style="border: 0; border-top: 1px solid #444; margin: 15px 0;">

                    <div class="btn-row">
                        <button onclick="downloadBackup()" class="btn-save" style="background: #3498db; flex: 1;">
                            Download Manual
                        </button>
                        
                        <input type="file" id="restore-input" style="display: none;" onchange="uploadRestore(this)">
                        <button onclick="document.getElementById('restore-input').click()" class="btn-save" style="background: #e67e22; flex: 1;">
                            Restore Backup
                        </button>
                    </div>
                </div>
            </div>

        </div>

        <div class="settings-column">
            
            <div class="card panel">
                <div class="panel-header">
                    <h3>Categories</h3>
                </div>
                <div class="panel-body">
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <input type="text" id="new_cat_name" placeholder="New Category Name" 
                               style="flex:1; padding: 8px;" onkeypress="handleEnter(event)">
                        <button onclick="addCategory()" class="btn-small" style="background:var(--accent);">Add</button>
                    </div>
                    
                    <div id="category-list" class="scroll-list" style="max-height: 400px; overflow-y: auto;">
                        <div style="padding:10px; color:#888;">Loading...</div>
                    </div>
                </div>
            </div>

            <div class="card panel">
                <div class="panel-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <h3>Metadata Plugins</h3>
                    <div style="display: flex; gap: 5px;">
                        <input type="file" id="plugin_upload_input" accept=".py" style="display:none;" onchange="uploadPluginFile(this)">
                        <button onclick="document.getElementById('plugin_upload_input').click()" class="btn-small">
                            + Upload (.py)
                        </button>
                    </div>
                </div>
                
                <div class="panel-body">
                    <p class="help-text" style="margin-bottom: 15px;">
                        Upload Python scripts to add new sources. Click a plugin to configure it.
                    </p>
                    
                    <div id="plugin-config-list" class="scroll-list plugin-list" style="max-height: 400px; overflow-y: auto">
                        <div style="color:#888; padding: 10px;">Loading plugins...</div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div class="card panel" style="margin-top: 20px;">
        <div class="panel-header" style="display: flex; justify-content: space-between; align-items: center; padding: 10px 15px;">
            <h4 style="margin:0;">Server Logs</h4>
            <div>
                <button onclick="fetchLogs()" class="btn-small">Refresh</button>
                <button onclick="clearLogs()" class="btn-small" style="background:#c0392b; margin-left:5px;">Clear</button>
            </div>
        </div>
        <div class="panel-body" style="padding: 0;">
            <pre id="log-output">Loading logs...</pre>
        </div>
    </div>

</div>

<style>
    /* LAYOUT UTILS */
    .settings-wrapper {
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
    }
    
    .header-row {
        margin-bottom: 20px; 
        border-bottom: 1px solid #333; 
        padding-bottom: 10px;
    }

    .settings-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        align-items: start;
    }

    .settings-column {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .btn-row {
        display: flex; 
        gap: 10px; 
        margin-bottom: 10px;
    }

    /* CARD STYLES */
    .card.panel {
        background: #2d2d2d;
        border-radius: 8px;
        border: 1px solid #444;
        overflow: hidden;
    }

    .panel-header {
        background: #222;
        padding: 15px;
        border-bottom: 1px solid #444;
    }
    .panel-header h3 { margin: 0; font-size: 1.1rem; color: var(--accent); }

    .panel-body { padding: 15px; }

    /* SCROLL LISTS */
    .scroll-list {
        background: #1a1a1a;
        border: 1px solid #444;
        border-radius: 4px;
        overflow-y: auto;
    }

    /* FORMS */
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; color: #aaa; margin-bottom: 5px; font-size: 0.9rem; }
    
    .row-group { 
        display: flex; 
        align-items: center; 
        gap: 10px; 
        background: #222;
        padding: 10px;
        border-radius: 4px;
        border: 1px solid #333;
    }
    
    select, input[type="text"] {
        width: 100%; padding: 8px;
        background: #111; border: 1px solid #444; color: white; border-radius: 4px;
        box-sizing: border-box; /* Fix for resizing */
    }

    /* PLUGINS ACCORDION */
    .plugin-item { border-bottom: 1px solid #333; }
    .plugin-header {
        padding: 12px 15px;
        background: #252525;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background 0.2s;
        user-select: none;
    }
    .plugin-header:hover { background: #333; }
    
    .plugin-body {
        display: none;
        padding: 15px;
        background: #1a1a1a;
        border-top: 1px solid #333;
    }
    .plugin-body.open { display: block; }

    /* LOGS */
    #log-output {
        height: 150px;
        overflow-y: auto;
        padding: 10px;
        margin: 0;
        font-family: monospace;
        font-size: 0.85rem;
        color: #ccc;
        background: #111;
        white-space: pre-wrap; 
        border: none;
    }

    /* --- MOBILE OPTIMIZATION --- */
    @media (max-width: 800px) {

        /* 2. Stack Grid */
        .settings-grid { 
            grid-template-columns: 1fr; 
        }

        /* 3. Stack Button Rows (Download/Restore) */
        .btn-row {
            flex-direction: column;
        }

        /* 4. Padding */
        .settings-wrapper {
            padding: 10px;
        }
    }
</style>

<script>
    // --- GLOBAL SETTINGS ---
    async function loadSettings() {
        const res = await fetch('/api/settings');
        const data = await res.json();
        if (data.default_direction) document.getElementById('set_direction').value = data.default_direction;
        if (data.show_uncategorized === "true") document.getElementById('set_show_uncategorized').checked = true;
        if (data.server_name) document.getElementById('set_server_name').value = data.server_name;
        // Load Backup Settings
        const bkEnabled = data.auto_backup_enabled === "true";
        document.getElementById('bk_enabled').checked = bkEnabled;
        document.getElementById('bk_frequency').value = data.auto_backup_frequency || 7;
        document.getElementById('bk_val_display').innerText = (data.auto_backup_frequency || 7) + " Days";
        toggleBackupSlider(); 
    }

    async function saveSettings(e) {
        e.preventDefault();
        const payload = {
            default_direction: document.getElementById('set_direction').value,
            show_uncategorized: document.getElementById('set_show_uncategorized').checked ? "true" : "false",
            server_name: document.getElementById('set_server_name').value
        };
        const res = await fetch('/api/settings', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        if (res.ok) {
            alert("Settings Saved!");
            location.reload(); 
        }
    }

    // --- CATEGORIES ---
    async function loadCategories() {
        const res = await fetch('/api/categories');
        const cats = await res.json();
        const list = document.getElementById('category-list');
        list.innerHTML = '';
        if (cats.length === 0) {
            list.innerHTML = '<div style="padding:10px; color:#888;">No categories created yet.</div>';
            return;
        }
        cats.forEach(cat => {
            const item = document.createElement('div');
            item.style.padding = '8px 10px';
            item.style.borderBottom = '1px solid #333';
            item.style.display = 'flex';
            item.style.justifyContent = 'space-between';
            item.innerHTML = `<span>${cat.name} <small style="color:#666;">(${cat.count})</small></span> 
                              <button onclick="deleteCategory(${cat.id})" style="background:#c0392b; border:none; color:white; padding:2px 6px; border-radius:3px; cursor:pointer;">Ã—</button>`;
            list.appendChild(item);
        });
    }

    function handleEnter(e) { if (e.key === 'Enter') addCategory(); }

    async function addCategory() {
        const input = document.getElementById('new_cat_name');
        const name = input.value.trim();
        if(!name) return;
        const res = await fetch('/api/categories', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name: name})
        });
        if(res.ok) { input.value = ''; loadCategories(); }
    }

    async function deleteCategory(id, force=false) {
        let url = `/api/categories/${id}`;
        if (force) url += '?force=true';
        const res = await fetch(url, { method: 'DELETE' });
        const data = await res.json();
        if (data.status === 'conflict') {
            if (confirm(`${data.message}\nDelete anyway?`)) deleteCategory(id, true);
        } else if (data.status === 'deleted') loadCategories();
    }

    // --- PLUGINS ---
    async function loadPlugins() {
        try {
            const res = await fetch('/api/plugins');
            const plugins = await res.json();
            const container = document.getElementById('plugin-config-list');
            container.innerHTML = '';

            if (plugins.length === 0) {
                container.innerHTML = '<div style="padding:15px; color:#888; text-align:center;">No plugins installed.</div>';
                return;
            }

            plugins.forEach(p => {
                const div = document.createElement('div');
                div.className = 'plugin-item';

                const header = document.createElement('div');
                header.className = 'plugin-header';
                header.innerHTML = `<strong>${p.name}</strong> <span style="font-size:0.8rem; color:#888;">v${p.version || '1.0'}</span>`;
                
                header.onclick = function() {
                    const body = div.querySelector('.plugin-body');
                    body.classList.toggle('open');
                };

                let bodyHtml = `<div class="plugin-body">`;
                if (p.fields.length === 0) {
                    bodyHtml += `<div style="font-style:italic; color:#666; margin-bottom:10px;">No configuration required.</div>`;
                } else {
                    p.fields.forEach(f => {
                        bodyHtml += `
                            <div class="form-group">
                                <label>${f.label}</label>
                                <input type="text" class="plugin-cfg-input" 
                                       data-plugin="${p.id}" data-key="${f.key}" 
                                       value="${f.value}">
                            </div>
                        `;
                    });
                    bodyHtml += `<div style="text-align:right;"><button onclick="savePluginConfig('${p.id}')" class="btn-save" style="width:auto; padding:5px 15px;">Save Config</button></div>`;
                }
                bodyHtml += `</div>`;

                div.appendChild(header);
                div.insertAdjacentHTML('beforeend', bodyHtml);
                container.appendChild(div);
            });
        } catch(e) { console.error(e); }
    }

    async function savePluginConfig(pluginId) {
        const inputs = document.querySelectorAll(`.plugin-cfg-input[data-plugin="${pluginId}"]`);
        const config = {};
        inputs.forEach(inp => config[inp.dataset.key] = inp.value);
        const res = await fetch('/api/plugins/config', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ plugin_id: pluginId, config: config })
        });
        if (res.ok) alert("Config Saved!");
    }

    async function uploadPluginFile(input, force=false) {
        if (!input.files[0]) return;
        const formData = new FormData();
        formData.append("file", input.files[0]);
        
        let url = '/api/plugins/upload';
        if (force) url += '?force=true';

        try {
            const res = await fetch(url, { method: 'POST', body: formData });
            const data = await res.json();

            if (data.status === 'success') {
                alert(`Plugin uploaded successfully (v${data.version})! Click OK to refresh.`);
                location.reload();
            } else if (data.status === 'confirm') {
                if (confirm(data.message)) uploadPluginFile(input, true);
                else input.value = '';
            } else {
                alert("Upload failed: " + (data.detail || "Unknown error"));
            }
        } catch(e) { alert("Error: " + e); }
    }

    // --- LOGS ---
    async function fetchLogs() {
        const res = await fetch('/api/logs');
        const data = await res.json();
        const logBox = document.getElementById('log-output');
        
        if (logBox.innerText !== data.logs) {
            logBox.innerText = data.logs;
            logBox.scrollTop = logBox.scrollHeight;
        }
    }
    async function clearLogs() {
        if (!confirm("Clear logs?")) return;
        const res = await fetch('/api/logs', { method: 'DELETE' });
        if (res.ok) fetchLogs();
    }

    // --- BACKUP ---
    async function downloadBackup() {
        const a = document.createElement("a");
        a.href = "/api/backup";
        a.download = `manga_server_backup_${new Date().toISOString().slice(0, 10)}.json`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }
    async function uploadRestore(input) {
        if (!input.files[0] || !confirm("This will overwrite your database. Continue?")) return;
        const formData = new FormData();
        formData.append("file", input.files[0]);
        const res = await fetch("/api/restore", { method: "POST", body: formData });
        if (res.ok) { alert("Restore Complete!"); location.reload(); }
        else alert("Restore Failed");
    }

    function toggleBackupSlider() {
        const enabled = document.getElementById('bk_enabled').checked;
        const container = document.getElementById('bk_slider_container');
        if (enabled) {
            container.style.opacity = "1";
            container.style.pointerEvents = "auto";
        } else {
            container.style.opacity = "0.5";
            container.style.pointerEvents = "none";
        }
    }

    async function saveBackupSettings() {
        const payload = {
            auto_backup_enabled: document.getElementById('bk_enabled').checked ? "true" : "false",
            auto_backup_frequency: document.getElementById('bk_frequency').value
        };
        const res = await fetch('/api/settings', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        if (res.ok) alert("Backup Settings Saved!");
    }

    // INIT
    loadSettings();
    loadCategories();
    loadPlugins();
    fetchLogs();
    setInterval(fetchLogs, 5000);
</script>
{% endblock %}