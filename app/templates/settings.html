{% extends "base.html" %}

{% block title %}Settings{% endblock %}

{% block content %}
<div class="settings-wrapper">

    <div style="margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px;">
        <h1>System Settings</h1>
    </div>

    <div class="settings-grid">
        
        <div class="settings-column">
            
            <div class="card panel">
                <div class="panel-header">
                    <h3>Global Configuration</h3>
                </div>
                <div class="panel-body">
                    <form onsubmit="saveSettings(event)">
                        <div class="form-group">
                            <label>Server Name</label>
                            <input type="text" id="set_server_name" placeholder="Manga Server">
                        </div>
                        <div class="form-group">
                            <label>Default Reading Direction</label>
                            <select id="set_direction">
                                <option value="LTR">Left to Right (Comic)</option>
                                <option value="RTL">Right to Left (Manga)</option>
                            </select>
                        </div>

                        <div class="form-group row-group">
                            <input type="checkbox" id="set_show_uncategorized" style="width: auto; margin: 0;">
                            <label for="set_show_uncategorized" style="margin: 0; cursor: pointer;">Show "Uncategorized" Filter</label>
                        </div>

                        <button type="submit" class="btn-save" style="margin-top: 10px;">Save Globals</button>
                    </form>
                </div>
            </div>
            <div class="card panel">
                <div class="panel-header">
                    <h3>System & Network</h3>
                </div>
                <div class="panel-body">
                    <div class="form-group">
                        <label>Device Name (Hostname)</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="sys_hostname" placeholder="mangaserver">
                            <button onclick="saveHostname()" class="btn-small" style="background: #34495e;">Rename</button>
                        </div>
                        <div style="font-size: 0.8rem; color: #666; margin-top: 5px;">
                            Access via: <span id="sys_address_preview" style="color: var(--accent);">http://...</span>
                        </div>
                    </div>

                    <hr style="border: 0; border-top: 1px solid #444; margin: 15px 0;">

                    <div class="form-group">
                        <label>Network Mode</label>
                        <div id="net_status_badge" style="background: #2ecc71; color: white; padding: 5px 10px; border-radius: 4px; display: inline-block; font-size: 0.9rem; margin-bottom: 10px;">
                            Checking...
                        </div>
                        <div style="font-size: 0.85rem; color: #aaa; margin-bottom: 10px;">
                            Current IP: <span id="net_ip" style="font-family: monospace; color: white;">...</span>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <button onclick="toggleHotspot()" id="btn_hotspot" class="btn-save" style="background: #e67e22; flex: 1; margin: 0;">
                                Switch to Hotspot Mode
                            </button>
                            <button onclick="openWifiModal()" class="btn-save" style="background: #34495e; flex: 1; margin: 0;">
                                Scan Wi-Fi
                            </button>
                        </div>
                        <p style="font-size: 0.8rem; color: #888; margin-top: 10px; line-height: 1.4;">
                            <strong>Warning:</strong> Switching modes will disconnect you. You will need to reconnect to the new network manually.
                        </p>
                    </div>
                    <hr style="border-color:#444; margin: 20px 0;">
            
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <label style="color:#e74c3c; font-weight:bold;">Power Control</label>
                            <div class="help-text">Safely shut down the Raspberry Pi</div>
                        </div>
                        <button onclick="shutdownSystem()" style="background:#c0392b; color:white; border:none; padding:10px 20px; border-radius:4px; cursor:pointer; font-weight:bold;">
                            Shutdown System
                        </button>
                    </div>
                </div>
            </div>
            <div class="card panel">
                <div class="panel-header">
                    <h3>Database & Backup</h3>
                </div>
                <div class="panel-body">
                    <div style="margin-bottom: 20px; background: #252525; padding: 10px; border-radius: 4px;">
                        <div class="form-group row-group" style="margin-bottom: 10px; background: transparent; border: none; padding: 0;">
                            <input type="checkbox" id="bk_enabled" style="width: auto; margin: 0;" onchange="toggleBackupSlider()">
                            <label for="bk_enabled" style="margin: 0; cursor: pointer; font-weight: bold; color: white;">Enable Auto-Backup</label>
                        </div>

                        <div id="bk_slider_container" style="opacity: 0.5; pointer-events: none; transition: opacity 0.2s;">
                            <label style="display: flex; justify-content: space-between; color: #aaa; font-size: 0.9rem; margin-bottom: 5px;">
                                <span>Backup Frequency</span>
                                <span id="bk_val_display" style="color: var(--accent);">7 Days</span>
                            </label>
                            <input type="range" id="bk_frequency" min="1" max="180" value="7" style="width: 100%; cursor: pointer;" 
                                   oninput="document.getElementById('bk_val_display').innerText = this.value + ' Days'">
                        </div>
                        
                        <div style="text-align: right; margin-top: 10px;">
                            <button onclick="saveBackupSettings()" class="btn-small" style="background: #2ecc71;">Save Backup Settings</button>
                        </div>
                    </div>

                    <hr style="border: 0; border-top: 1px solid #444; margin: 15px 0;">

                    <div style="display: flex; gap: 10px;">
                        <button onclick="downloadBackup()" class="btn-save" style="background: #3498db; flex: 1;">
                            Download Manual
                        </button>
                        
                        <input type="file" id="restore-input" style="display: none;" onchange="uploadRestore(this)">
                        <button onclick="document.getElementById('restore-input').click()" class="btn-save" style="background: #e67e22; flex: 1;">
                            Restore Backup
                        </button>
                    </div>
                </div>
            </div>

        </div>

        <div class="settings-column">
            
            <div class="card panel">
                <div class="panel-header">
                    <h3>Categories</h3>
                </div>
                <div class="panel-body">
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <input type="text" id="new_cat_name" placeholder="New Category Name" 
                               style="flex:1; padding: 8px;" onkeypress="handleEnter(event)">
                        <button onclick="addCategory()" class="btn-small" style="background:var(--accent);">Add</button>
                    </div>
                    
                    <div id="category-list" class="scroll-list" style="max-height: 400px; overflow-y: auto;">
                        <div style="padding:10px; color:#888;">Loading...</div>
                    </div>
                </div>
            </div>

            <div class="card panel">
                <div class="panel-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <h3>Metadata Plugins</h3>
                    <div style="display: flex; gap: 5px;">
                        <input type="file" id="plugin_upload_input" accept=".py" style="display:none;" onchange="uploadPluginFile(this)">
                        <button onclick="document.getElementById('plugin_upload_input').click()" class="btn-small">
                            + Upload (.py)
                        </button>
                    </div>
                </div>
                
                <div class="panel-body">
                    <p class="help-text" style="margin-bottom: 15px;">
                        Upload Python scripts to add new sources. Click a plugin to configure it.
                    </p>
                    
                    <div id="plugin-config-list" class="scroll-list plugin-list" style="max-height: 400px; overflow-y: auto">
                        <div style="color:#888; padding: 10px;">Loading plugins...</div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div class="card panel" style="margin-top: 20px;">
        <div class="panel-header" style="display: flex; justify-content: space-between; align-items: center; padding: 10px 15px;">
            <h4 style="margin:0;">Server Logs</h4>
            <div>
                <button onclick="fetchLogs()" class="btn-small">Refresh</button>
                <button onclick="clearLogs()" class="btn-small" style="background:#c0392b; margin-left:5px;">Clear</button>
            </div>
        </div>
        <div class="panel-body" style="padding: 0;">
            <pre id="log-output">Loading logs...</pre>
        </div>
    </div>

</div>

<div id="wifi-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:2000; justify-content:center; align-items:center;">
    <div style="background:#2d2d2d; padding:20px; border-radius:8px; width:400px; max-width:90%; max-height:80vh; display:flex; flex-direction:column;">
        <h2 style="margin-top:0;">Connect to Wi-Fi</h2>
           
        <div id="wifi-list" style="overflow-y:auto; flex:1; border:1px solid #444; margin-bottom:15px; min-height:150px;">
            <div style="padding:20px; text-align:center; color:#888;">Scanning...</div>
        </div>

        <div id="wifi-form" style="display:none;">
            <div style="margin-bottom:10px; font-weight:bold; color:var(--accent);" id="selected-ssid"></div>
            <input type="password" id="wifi-pass" placeholder="Password (leave empty if Open)" style="width:100%; padding:10px; margin-bottom:10px; background:#1a1a1a; border:1px solid #444; color:white;">
            <div style="display:flex; gap:10px;">
                <button onclick="saveWifi()" class="btn-save" style="margin:0;">Connect</button>
                <button onclick="backToList()" style="background:#555; color:white; border:none; padding:10px; border-radius:4px; cursor:pointer;">Back</button>
            </div>
        </div>

        <button id="btn-cancel-wifi" onclick="document.getElementById('wifi-modal').style.display='none'" style="margin-top:10px; background:transparent; border:none; color:#888; cursor:pointer; text-decoration:underline;">Cancel</button>
    </div>
</div>

<style>
    /* LAYOUT UTILS */
    .settings-wrapper {
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
    }

    .settings-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        align-items: start;
    }

    @media (max-width: 800px) {
        .settings-grid { grid-template-columns: 1fr; }
    }

    .settings-column {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    /* CARD STYLES */
    .card.panel {
        background: #2d2d2d;
        border-radius: 8px;
        border: 1px solid #444;
        overflow: hidden;
    }

    .panel-header {
        background: #222;
        padding: 15px;
        border-bottom: 1px solid #444;
    }
    .panel-header h3 { margin: 0; font-size: 1.1rem; color: var(--accent); }

    .panel-body { padding: 15px; }

    /* SCROLL LISTS */
    .scroll-list {
        background: #1a1a1a;
        border: 1px solid #444;
        border-radius: 4px;
        overflow-y: auto;
    }

    /* FORMS */
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; color: #aaa; margin-bottom: 5px; font-size: 0.9rem; }
    
    /* Fixed Row Group for Checkbox alignment */
    .row-group { 
        display: flex; 
        align-items: center; 
        gap: 10px; 
        background: #222;
        padding: 10px;
        border-radius: 4px;
        border: 1px solid #333;
    }
    
    select, input[type="text"] {
        width: 100%; padding: 8px;
        background: #111; border: 1px solid #444; color: white; border-radius: 4px;
    }

    /* PLUGINS ACCORDION STYLE */
    .plugin-item {
        border-bottom: 1px solid #333;
    }
    .plugin-header {
        padding: 12px 15px;
        background: #252525;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background 0.2s;
        user-select: none;
    }
    .plugin-header:hover { background: #333; }
    
    .plugin-body {
        display: none;
        padding: 15px;
        background: #1a1a1a;
        border-top: 1px solid #333;
    }
    .plugin-body.open { display: block; }

    /* LOGS */
    #log-output {
        height: 150px;
        overflow-y: auto;
        padding: 10px;
        margin: 0;
        font-family: monospace;
        font-size: 0.85rem;
        color: #ccc;
        background: #111;
        white-space: pre-wrap; 
        border: none;
    }
</style>

<script>
    // --- GLOBAL SETTINGS ---
    async function loadSettings() {
        const res = await fetch('/api/settings');
        const data = await res.json();
        if (data.default_direction) document.getElementById('set_direction').value = data.default_direction;
        if (data.show_uncategorized === "true") document.getElementById('set_show_uncategorized').checked = true;
        if (data.server_name) document.getElementById('set_server_name').value = data.server_name;
        // Load Backup Settings
        const bkEnabled = data.auto_backup_enabled === "true";
        document.getElementById('bk_enabled').checked = bkEnabled;
        document.getElementById('bk_frequency').value = data.auto_backup_frequency || 7;
        document.getElementById('bk_val_display').innerText = (data.auto_backup_frequency || 7) + " Days";
        toggleBackupSlider(); // Set initial visual state
    }

    async function saveSettings(e) {
        e.preventDefault();
        const payload = {
            default_direction: document.getElementById('set_direction').value,
            show_uncategorized: document.getElementById('set_show_uncategorized').checked ? "true" : "false",
            server_name: document.getElementById('set_server_name').value
        };
        const res = await fetch('/api/settings', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        if (res.ok) {
            alert("Settings Saved!");
            location.reload(); 
        }
    }

    // --- CATEGORIES ---
    async function loadCategories() {
        const res = await fetch('/api/categories');
        const cats = await res.json();
        const list = document.getElementById('category-list');
        list.innerHTML = '';
        if (cats.length === 0) {
            list.innerHTML = '<div style="padding:10px; color:#888;">No categories created yet.</div>';
            return;
        }
        cats.forEach(cat => {
            const item = document.createElement('div');
            item.style.padding = '8px 10px';
            item.style.borderBottom = '1px solid #333';
            item.style.display = 'flex';
            item.style.justifyContent = 'space-between';
            item.innerHTML = `<span>${cat.name} <small style="color:#666;">(${cat.count})</small></span> 
                              <button onclick="deleteCategory(${cat.id})" style="background:#c0392b; border:none; color:white; padding:2px 6px; border-radius:3px; cursor:pointer;">√ó</button>`;
            list.appendChild(item);
        });
    }

    function handleEnter(e) { if (e.key === 'Enter') addCategory(); }

    async function addCategory() {
        const input = document.getElementById('new_cat_name');
        const name = input.value.trim();
        if(!name) return;
        const res = await fetch('/api/categories', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name: name})
        });
        if(res.ok) { input.value = ''; loadCategories(); }
    }

    async function deleteCategory(id, force=false) {
        let url = `/api/categories/${id}`;
        if (force) url += '?force=true';
        const res = await fetch(url, { method: 'DELETE' });
        const data = await res.json();
        if (data.status === 'conflict') {
            if (confirm(`${data.message}\nDelete anyway?`)) deleteCategory(id, true);
        } else if (data.status === 'deleted') loadCategories();
    }

    // --- PLUGINS ---
    async function loadPlugins() {
        try {
            const res = await fetch('/api/plugins');
            const plugins = await res.json();
            const container = document.getElementById('plugin-config-list');
            container.innerHTML = '';

            if (plugins.length === 0) {
                container.innerHTML = '<div style="padding:15px; color:#888; text-align:center;">No plugins installed.</div>';
                return;
            }

            plugins.forEach(p => {
                const div = document.createElement('div');
                div.className = 'plugin-item';

                const header = document.createElement('div');
                header.className = 'plugin-header';
                header.innerHTML = `<strong>${p.name}</strong> <span style="font-size:0.8rem; color:#888;">v${p.version || '1.0'}</span>`;
                
                header.onclick = function() {
                    const body = div.querySelector('.plugin-body');
                    body.classList.toggle('open');
                };

                let bodyHtml = `<div class="plugin-body">`;
                if (p.fields.length === 0) {
                    bodyHtml += `<div style="font-style:italic; color:#666; margin-bottom:10px;">No configuration required.</div>`;
                } else {
                    p.fields.forEach(f => {
                        bodyHtml += `
                            <div class="form-group">
                                <label>${f.label}</label>
                                <input type="text" class="plugin-cfg-input" 
                                       data-plugin="${p.id}" data-key="${f.key}" 
                                       value="${f.value}">
                            </div>
                        `;
                    });
                    bodyHtml += `<div style="text-align:right;"><button onclick="savePluginConfig('${p.id}')" class="btn-save" style="width:auto; padding:5px 15px;">Save Config</button></div>`;
                }
                bodyHtml += `</div>`;

                div.appendChild(header);
                div.insertAdjacentHTML('beforeend', bodyHtml);
                container.appendChild(div);
            });
        } catch(e) { console.error(e); }
    }

    async function savePluginConfig(pluginId) {
        const inputs = document.querySelectorAll(`.plugin-cfg-input[data-plugin="${pluginId}"]`);
        const config = {};
        inputs.forEach(inp => config[inp.dataset.key] = inp.value);
        const res = await fetch('/api/plugins/config', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ plugin_id: pluginId, config: config })
        });
        if (res.ok) alert("Config Saved!");
    }

    async function uploadPluginFile(input, force=false) {
        if (!input.files[0]) return;
        const formData = new FormData();
        formData.append("file", input.files[0]);
        
        let url = '/api/plugins/upload';
        if (force) url += '?force=true';

        try {
            const res = await fetch(url, { method: 'POST', body: formData });
            const data = await res.json();

            if (data.status === 'success') {
                alert(`Plugin uploaded successfully (v${data.version})! Click OK to refresh.`);
                location.reload();
            } else if (data.status === 'confirm') {
                if (confirm(data.message)) uploadPluginFile(input, true);
                else input.value = '';
            } else {
                alert("Upload failed: " + (data.detail || "Unknown error"));
            }
        } catch(e) { alert("Error: " + e); }
    }

    // --- LOGS ---
    async function fetchLogs() {
        const res = await fetch('/api/logs');
        const data = await res.json();
        const logBox = document.getElementById('log-output');
        
        if (logBox.innerText !== data.logs) {
            logBox.innerText = data.logs;
            logBox.scrollTop = logBox.scrollHeight;
        }
    }
    async function clearLogs() {
        if (!confirm("Clear logs?")) return;
        const res = await fetch('/api/logs', { method: 'DELETE' });
        if (res.ok) fetchLogs();
    }

    // --- BACKUP ---
    async function downloadBackup() {
        const a = document.createElement("a");
        a.href = "/api/backup";
        a.download = `manga_server_backup_${new Date().toISOString().slice(0, 10)}.json`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }
    async function uploadRestore(input) {
        if (!input.files[0] || !confirm("This will overwrite your database. Continue?")) return;
        const formData = new FormData();
        formData.append("file", input.files[0]);
        const res = await fetch("/api/restore", { method: "POST", body: formData });
        if (res.ok) { alert("Restore Complete!"); location.reload(); }
        else alert("Restore Failed");
    }

    function toggleBackupSlider() {
        const enabled = document.getElementById('bk_enabled').checked;
        const container = document.getElementById('bk_slider_container');
        if (enabled) {
            container.style.opacity = "1";
            container.style.pointerEvents = "auto";
        } else {
            container.style.opacity = "0.5";
            container.style.pointerEvents = "none";
        }
    }

    async function saveBackupSettings() {
        const payload = {
            auto_backup_enabled: document.getElementById('bk_enabled').checked ? "true" : "false",
            auto_backup_frequency: document.getElementById('bk_frequency').value
        };
        const res = await fetch('/api/settings', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        if (res.ok) alert("Backup Settings Saved!");
    }

    // --- SYSTEM INFO ---
    async function loadSystemInfo() {
        try {
            const res = await fetch('/api/system/info');
            const data = await res.json();
            
            // Hostname
            document.getElementById('sys_hostname').value = data.hostname;
            
            // Network
            const net = data.network;
            const badge = document.getElementById('net_status_badge');
            const btn = document.getElementById('btn_hotspot');
            const ipDisplay = document.getElementById('net_ip');
            const urlPreview = document.getElementById('sys_address_preview');

            ipDisplay.innerText = net.ip;

            if (net.mode === 'hotspot') {
                // HOTSPOT MODE
                badge.innerText = "Hotspot Active";
                badge.style.backgroundColor = "#3498db"; 
                
                // Show the specific Hotspot URL
                urlPreview.innerHTML = `
                    <span style="color:#e74c3c; font-weight:bold;">http://${net.ip}:8000</span> 
                    <br><span style="color:#666; font-size:0.8em;">(Use this IP if .local fails)</span>
                `;
                
                btn.innerText = "Switch to Home Wi-Fi (Client)";
                btn.onclick = () => toggleHotspot(false);
                
            } else {
                // CLIENT MODE
                badge.innerText = `Connected: ${net.ssid}`;
                badge.style.backgroundColor = "#2ecc71"; 
                
                urlPreview.innerText = `http://${data.hostname}.local:8000`;
                
                btn.innerText = "Switch to Hotspot Mode";
                btn.onclick = () => toggleHotspot(true);
            }
        } catch(e) { console.error("System info error", e); }
    }

    async function saveHostname() {
        const name = document.getElementById('sys_hostname').value;
        if (!confirm(`Rename server to "${name}"? This may require a reboot.`)) return;
        
        const res = await fetch('/api/system/hostname', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ name: name })
        });
        const d = await res.json();
        alert(d.message);
    }

    async function toggleHotspot(enable) {
        let msg = "";
        
        if (enable) {
            // WARNING FOR SWITCHING TO HOTSPOT
            msg = "‚ö†Ô∏è SWITCHING TO HOTSPOT MODE ‚ö†Ô∏è\n\n" +
                  "1. The server will disconnect from your home Wi-Fi.\n" +
                  "2. You must connect your device to the 'MangaServer' Wi-Fi.\n" +
                  "3. The new address will be:\n\n" +
                  "   üëâ http://10.42.0.1:8000\n\n" +
                  "Click OK to proceed.";
        } else {
            // WARNING FOR SWITCHING TO CLIENT
            msg = "‚ö†Ô∏è SWITCHING TO CLIENT MODE ‚ö†Ô∏è\n\n" +
                  "The server will stop the Hotspot and connect to your home Wi-Fi.\n" +
                  "You will lose connection now.\n\n" +
                  "Look for the server at: http://raspberrypi.local:8000\n" +
                  "(Or check your router for the new IP address)";
        }

        if (!confirm(msg)) return;

        try {
            const res = await fetch('/api/system/hotspot', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ enable: enable })
            });
            
            const data = await res.json();
            
            if (res.ok) {
                alert("Command sent! Connection will drop in a few seconds.");
            } else {
                alert("Error: " + data.detail);
            }
        } catch (e) {
            // Expected to fail because connection drops instantly
            alert("Command sent! Connection dropping...");
        }
    }

    async function shutdownSystem() {
        if (!confirm("‚ö†Ô∏è SHUTDOWN WARNING ‚ö†Ô∏è\n\nAre you sure you want to turn off the Raspberry Pi?\n\nYou will need to physically unplug it and plug it back in to turn it on again.")) {
            return;
        }

        try {
            const res = await fetch('/api/system/shutdown', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ confirm: true })
            });
            
            if (res.ok) {
                document.body.innerHTML = `
                    <div style="display:flex; justify-content:center; align-items:center; height:100vh; background:#1a1a1a; color:white; flex-direction:column; text-align:center;">
                        <h1 style="color:#e74c3c;">System Shutting Down</h1>
                        <p>It is now safe to unplug the power when the green light stops flashing.</p>
                    </div>
                `;
            } else {
                alert("Shutdown failed. Check logs.");
            }
        } catch (e) {
            alert("Error sending shutdown command.");
        }
    }

    let selectedSSID = "";

    async function openWifiModal() {
        document.getElementById('wifi-modal').style.display = 'flex';
        document.getElementById('wifi-form').style.display = 'none';
        document.getElementById('wifi-list').style.display = 'block';
        document.getElementById('btn-cancel-wifi').style.display = 'block';
        document.getElementById('wifi-list').innerHTML = '<div style="padding:20px; text-align:center; color:#888;">Scanning networks...<br>(This may take 5-10 seconds)</div>';
        
        try {
            const res = await fetch('/api/system/wifi/scan');
            const networks = await res.json();
            
            const list = document.getElementById('wifi-list');
            list.innerHTML = '';
            
            if (networks.length === 0) {
                list.innerHTML = '<div style="padding:10px;">No networks found.</div>';
                return;
            }

            networks.forEach(net => {
                const item = document.createElement('div');
                item.style.padding = "10px";
                item.style.borderBottom = "1px solid #444";
                item.style.cursor = "pointer";
                item.style.display = "flex";
                item.style.justifyContent = "space-between";
                
                // Signal bars roughly
                let bars = "‚ñÇ";
                if(net.signal > 40) bars += "‚ñÑ";
                if(net.signal > 70) bars += "‚ñÜ";
                if(net.signal > 90) bars += "‚ñà";

                item.innerHTML = `
                    <div style="font-weight:bold;">${net.ssid}</div>
                    <div style="color:#888; font-size:0.8em;">${bars} ${net.security}</div>
                `;
                
                item.onclick = () => showPassForm(net.ssid);
                item.onmouseover = () => item.style.backgroundColor = "#333";
                item.onmouseout = () => item.style.backgroundColor = "transparent";
                
                list.appendChild(item);
            });
        } catch(e) {
            document.getElementById('wifi-list').innerHTML = '<div style="color:red; padding:10px;">Scan failed.</div>';
        }
    }

    function showPassForm(ssid) {
        selectedSSID = ssid;
        document.getElementById('wifi-list').style.display = 'none';
        document.getElementById('btn-cancel-wifi').style.display = 'none';
        document.getElementById('wifi-form').style.display = 'block';
        document.getElementById('selected-ssid').innerText = `Selected: ${ssid}`;
        document.getElementById('wifi-pass').value = '';
        document.getElementById('wifi-pass').focus();
    }

    function backToList() {
        document.getElementById('wifi-form').style.display = 'none';
        document.getElementById('wifi-list').style.display = 'block';
        document.getElementById('btn-cancel-wifi').style.display = 'block';
    }

    async function saveWifi() {
        const pass = document.getElementById('wifi-pass').value;
        const btn = document.querySelector('#wifi-form .btn-save');
        const originalText = btn.innerText;
        
        btn.disabled = true;
        btn.innerText = "Saving...";

        try {
            const res = await fetch('/api/system/wifi/connect', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ ssid: selectedSSID, password: pass })
            });
            
            const data = await res.json();
            
            if(res.ok) {
                alert(data.message);
                document.getElementById('wifi-modal').style.display = 'none';
                // Automatically prompt to switch modes?
                if(confirm("New Wi-Fi saved. Switch to Client Mode now?")) {
                    toggleHotspot(false); // Switch to client
                }
            } else {
                alert("Error: " + data.detail);
            }
        } catch(e) {
            alert("Failed to save connection.");
        } finally {
            btn.disabled = false;
            btn.innerText = originalText;
        }
    }

    // INIT
    loadSettings();
    loadCategories();
    loadPlugins();
    fetchLogs();
    setInterval(fetchLogs, 5000);
    loadSystemInfo();
</script>
{% endblock %}