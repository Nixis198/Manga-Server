{% extends "base.html" %}

{% block title %}Settings{% endblock %}

{% block content %}
<div class="settings-container">
    
    <div class="settings-left-column">
        
        <div class="settings-panel">
            <h2>Global Configuration</h2>
            <form onsubmit="saveSettings(event)">
                <div class="form-group">
                    <label>Default Reading Direction</label>
                    <div class="help-text">Applied to new imports automatically.</div>
                    <select id="set_direction">
                        <option value="LTR">Left to Right (Comic)</option>
                        <option value="RTL">Right to Left (Manga)</option>
                    </select>
                </div>

                <div class="form-group" style="display:flex; align-items:center; gap:10px; margin-top:15px;">
                    <input type="checkbox" id="set_show_uncategorized" style="width:auto;">
                    <div>
                        <label style="margin:0; cursor:pointer;" for="set_show_uncategorized">Show "Uncategorized" Filter</label>
                        <div class="help-text">Only visible if uncategorized galleries exist.</div>
                    </div>
                </div>

                <button type="submit" class="btn-save">Save Settings</button>
            </form>
        </div>

        <div class="settings-panel">
            <h2>Categories</h2>
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <input type="text" id="new_cat_name" placeholder="New Category Name" 
                       style="flex:1; padding: 8px;"
                       onkeypress="handleEnter(event)">
                <button onclick="addCategory()" class="btn-small" style="background:var(--accent);">Add</button>
            </div>
            
            <div id="category-list" class="list-group" style="max-height: 300px; overflow-y: auto; border: 1px solid #444; border-radius: 4px;">
                <div style="padding:10px; color:#888;">Loading...</div>
            </div>
        </div>
        <div class="settings-panel">
            <h2>Database Maintenance</h2>
            <p class="help-text">Export your metadata to a JSON file or restore from a backup.</p>
            
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button onclick="downloadBackup()" class="btn-save" style="background: var(--accent); flex: 1;">
                    Download Backup
                </button>
                
                <input type="file" id="restore-input" style="display: none;" onchange="uploadRestore(this)">
                <button onclick="document.getElementById('restore-input').click()" class="btn-save" style="background: #e67e22; flex: 1;">
                    Restore Backup
                </button>
            </div>
        </div>
    </div>

    <div class="logs-panel">
        <div class="panel-header">
            <h3>Server Logs</h3>
                <div>
                    <button onclick="fetchLogs()" class="btn-small">Refresh</button>
                    <button onclick="clearLogs()" class="btn-small" style="background:#c0392b; margin-left:5px;">Clear</button>
                </div>
            </div>
        <div class="console-window">
            <pre id="log-output">Loading logs...</pre>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
    // --- GLOBAL SETTINGS LOGIC ---

    async function loadSettings() {
        const res = await fetch('/api/settings');
        const data = await res.json();
        
        if (data.default_direction) {
            document.getElementById('set_direction').value = data.default_direction;
        }
        
        if (data.show_uncategorized === "true") {
            document.getElementById('set_show_uncategorized').checked = true;
        }
    }

    async function saveSettings(e) {
        e.preventDefault();
        const payload = {
            default_direction: document.getElementById('set_direction').value,
            show_uncategorized: document.getElementById('set_show_uncategorized').checked ? "true" : "false"
        };

        const res = await fetch('/api/settings', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });

        if (res.ok) {
            alert("Settings Saved!");
        } else {
            alert("Error saving settings.");
        }
    }

    // --- CATEGORY MANAGER LOGIC ---

    async function loadCategories() {
        const res = await fetch('/api/categories');
        const cats = await res.json();
        const list = document.getElementById('category-list');
        list.innerHTML = '';
        
        if (cats.length === 0) {
            list.innerHTML = '<div style="padding:10px; color:#888;">No categories created yet.</div>';
            return;
        }

        cats.forEach(cat => {
            const item = document.createElement('div');
            item.className = 'list-item'; 
            item.style.display = 'flex';
            item.style.justifyContent = 'space-between';
            item.style.alignItems = 'center';
            item.style.padding = '8px 10px';
            item.style.borderBottom = '1px solid #444';
            
            item.innerHTML = `
                <span>${cat.name} <span style="color:#888; font-size:0.8rem;">(${cat.count} items)</span></span>
                <button onclick="deleteCategory(${cat.id})" style="background:#c0392b; color:white; border:none; padding:2px 8px; border-radius:3px; cursor:pointer;">Ã—</button>
            `;
            list.appendChild(item);
        });
    }

    function handleEnter(e) {
        if (e.key === 'Enter') addCategory();
    }

    async function addCategory() {
        const input = document.getElementById('new_cat_name');
        const name = input.value.trim();
        if(!name) return;

        const res = await fetch('/api/categories', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name: name})
        });

        if(res.ok) {
            input.value = '';
            loadCategories();
        } else {
            const err = await res.json();
            alert("Error: " + err.detail);
        }
    }

    async function deleteCategory(id, force=false) {
        let url = `/api/categories/${id}`;
        if (force) url += '?force=true';

        const res = await fetch(url, { method: 'DELETE' });
        const data = await res.json();

        if (data.status === 'conflict') {
            if (confirm(`${data.message}\nDo you want to delete it anyway?`)) {
                deleteCategory(id, true);
            }
        } else if (data.status === 'deleted') {
            loadCategories();
        }
    }

    // --- LOGS LOGIC ---
    async function fetchLogs() {
        const res = await fetch('/api/logs');
        const data = await res.json();
        const logBox = document.getElementById('log-output');
        logBox.innerText = data.logs;
        logBox.scrollTop = logBox.scrollHeight;
    }

    async function clearLogs() {
        if (!confirm("Are you sure you want to clear the server logs?")) return;

        const res = await fetch('/api/logs', { method: 'DELETE' });
        
        if (res.ok) {
            // Refresh the view immediately
            fetchLogs();
        } else {
            alert("Failed to clear logs.");
        }
    }

    // --- BACKUP & RESTORE LOGIC ---

    async function downloadBackup() {
        // Trigger the download
        const a = document.createElement("a");
        a.href = "/api/backup";
        // Name the file with a timestamp
        const date = new Date().toISOString().slice(0, 10);
        a.download = `manga_server_backup_${date}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    async function uploadRestore(inputElement) {
        const file = inputElement.files[0];
        if (!file) return;

        if (!confirm("WARNING: This will wipe your current database and replace it with the backup. Continue?")) {
            inputElement.value = ''; // Reset input
            return;
        }

        const formData = new FormData();
        formData.append("file", file);

        // Show loading state (optional UI enhancement)
        const btn = inputElement.nextElementSibling; // The button we clicked
        const originalText = btn.innerText;
        btn.innerText = "Restoring...";
        btn.disabled = true;

        try {
            const res = await fetch("/api/restore", {
                method: "POST",
                body: formData
            });
            
            const result = await res.json();
            
            if (res.ok) {
                alert("Restore Successful! The page will now reload.");
                location.reload();
            } else {
                alert("Error: " + result.detail);
            }
        } catch (e) {
            alert("Upload failed: " + e);
        } finally {
            // Reset UI
            btn.innerText = originalText;
            btn.disabled = false;
            inputElement.value = '';
        }
    }

    // INIT
    loadSettings();
    loadCategories();
    fetchLogs();
    setInterval(fetchLogs, 5000);
</script>
{% endblock %}