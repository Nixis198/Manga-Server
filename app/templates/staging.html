{% extends "base.html" %}

{% block content %}
<div style="display: flex; height: calc(100vh - 80px); gap: 20px;">
    
    <div style="width: 300px; display: flex; flex-direction: column; background: #2d2d2d; border-right: 1px solid #444;">
        <div style="padding: 10px; background: #222; border-bottom: 1px solid #444; font-weight: bold;">
            Staging Area
            <button onclick="scanFiles()" class="btn-small" style="float:right;">Scan</button>
        </div>
        <div id="file-list" style="flex: 1; overflow-y: auto;">
            <div style="padding: 20px; color: #888; text-align: center;">Loading...</div>
        </div>
    </div>

    <div style="flex: 1; display: flex; flex-direction: column; overflow-y: auto; padding-right: 20px;">
        
        <div style="display: flex; gap: 20px; margin-bottom: 20px; background: #222; padding: 20px; border-radius: 8px;">
            <div style="width: 200px; height: 280px; background: #000; display: flex; align-items: center; justify-content: center; border: 1px solid #444;">
                <img id="preview-img" style="max-width: 100%; max-height: 100%; display: none;">
                <span id="preview-placeholder" style="color: #555;">Select a file</span>
            </div>
            <div style="flex: 1;">
                <h2 id="preview-filename" style="margin-top: 0; color: var(--accent); word-break: break-all;">No File Selected</h2>
                <p style="color: #888; font-size: 0.9rem;">
                    Select a file from the list to begin importing. You can manually enter metadata or use a plugin to fetch it.
                </p>
                <div id="file-path" style="font-family: monospace; color: #666; font-size: 0.8rem; margin-top: 10px;"></div>
            </div>
        </div>

        <div id="import-form-container" style="display: none;">
            <form id="import-form" onsubmit="submitImport(event)">
                <input type="hidden" id="inp_id">
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                    <div class="form-group">
                        <label>Title</label>
                        <input type="text" id="inp_title" required>
                    </div>
                    <div class="form-group">
                        <label>Artist</label>
                        <input type="text" id="inp_artist" required autocomplete="off">
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                    <div class="form-group">
                        <label>Series</label>
                        <input type="text" id="inp_series" autocomplete="off" placeholder="(Optional)">
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <select id="inp_category">
                            <option value="">(None)</option>
                        </select>
                    </div>
                </div>

                <div class="form-group" style="margin-bottom: 15px;">
                    <label>Tags (comma separated)</label>
                    <input type="text" id="inp_tags">
                </div>

                <div class="form-group" style="margin-bottom: 15px;">
                    <label>Description</label>
                    <textarea id="inp_desc" rows="3"></textarea>
                </div>
                
                <div class="form-group" style="margin-bottom: 20px;">
                     <label>Reading Direction</label>
                     <select id="inp_direction">
                         <option value="LTR">Left to Right (Comic)</option>
                         <option value="RTL">Right to Left (Manga)</option>
                     </select>
                </div>

                <div style="background: #252525; padding: 15px; border-radius: 5px; border: 1px solid #444; margin-bottom: 20px;">
                    <h4 style="margin-top: 0; color: #aaa;">Metadata Source</h4>
                    <div style="display: flex; gap: 10px; align-items: flex-end;">
                        <div class="form-group" style="flex: 1;">
                            <label>Source / Plugin</label>
                            <select id="plugin_source">
                                <option value="" disabled selected>Select a plugin...</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 2;">
                            <label>URL / ID</label>
                            <input type="text" id="plugin_url" placeholder="https://...">
                        </div>
                        <button type="button" onclick="runPlugin()" class="btn-small" style="margin-bottom: 2px;">Fetch</button>
                    </div>
                </div>

                <button type="submit" class="btn-save" style="width: 100%; padding: 12px; font-size: 1.1rem;">Save & Import</button>
            </form>
        </div>

    </div>
</div>

<style>
    .file-item {
        padding: 10px;
        border-bottom: 1px solid #333;
        cursor: pointer;
        font-size: 0.9rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .file-item:hover { background: #333; }
    .file-item.active { background: var(--accent); color: white; }
    
    .form-group label { display: block; color: #aaa; margin-bottom: 5px; font-size: 0.9rem; }
    
    input[type="text"], textarea, select {
        width: 100%; padding: 8px;
        background: #111; border: 1px solid #444; color: white; border-radius: 4px;
    }
    textarea { resize: vertical; }
</style>

<script>
    let stagedFiles = [];
    let knownArtists = [];
    let knownSeries = [];

    // --- 1. CORE LOADING LOGIC ---
    async function loadFiles() {
        const res = await fetch('/api/staged');
        stagedFiles = await res.json();
        renderList();
    }

    async function scanFiles() {
        document.getElementById('file-list').innerHTML = '<div style="padding:20px; text-align:center;">Scanning...</div>';
        await fetch('/api/scan', { method: 'POST' });
        loadFiles();
    }

    function renderList() {
        const list = document.getElementById('file-list');
        list.innerHTML = '';
        if (stagedFiles.length === 0) {
            list.innerHTML = '<div style="padding:20px; color:#888; text-align:center;">No files found.</div>';
            return;
        }

        stagedFiles.forEach(f => {
            const div = document.createElement('div');
            div.className = 'file-item';
            div.innerText = f.filename;
            div.onclick = () => selectFile(f.id);
            div.dataset.id = f.id; // Store ID for active highlighting
            list.appendChild(div);
        });
    }

    async function selectFile(id) {
        // Highlight logic
        document.querySelectorAll('.file-item').forEach(el => el.classList.remove('active'));
        const activeEl = document.querySelector(`.file-item[data-id="${id}"]`);
        if(activeEl) activeEl.classList.add('active');

        // Find data
        const file = stagedFiles.find(f => f.id === id);
        if (!file) return;

        // UI Updates
        document.getElementById('preview-filename').innerText = file.filename;
        document.getElementById('file-path').innerText = file.path;
        document.getElementById('preview-placeholder').style.display = 'none';
        
        const img = document.getElementById('preview-img');
        img.src = `/api/staged/${id}/cover`;
        img.style.display = 'block';

        // Show Form
        document.getElementById('import-form-container').style.display = 'block';
        document.getElementById('inp_id').value = id;
        
        // Auto-fill logic (Regex parse)
        // Try to guess Artist/Title from filename like "[Artist] Title (Event)"
        let title = file.filename;
        let artist = "";
        
        // Simple regex for [Artist] Title
        const match = title.match(/^\[(.*?)\]\s*(.*?)(\.zip|\.cbz)?$/);
        if (match) {
            artist = match[1];
            title = match[2];
            // Remove typical trailing tags like (C100)
            title = title.replace(/\s*\(.*?\)\s*/g, '').trim();
        } else {
            title = title.replace(/\.(zip|cbz)$/i, '');
        }

        document.getElementById('inp_title').value = title;
        document.getElementById('inp_artist').value = artist;
        document.getElementById('inp_series').value = "";
        document.getElementById('inp_tags').value = "";
        document.getElementById('inp_desc').value = "";
    }

    // --- 2. GHOST TEXT AUTOCOMPLETE ---
    async function loadAutocomplete() {
        try {
            const res = await fetch('/api/autocomplete');
            const data = await res.json();
            knownArtists = data.artists || [];
            knownSeries = data.series || [];
            
            setupGhostText('inp_artist', knownArtists);
            setupGhostText('inp_series', knownSeries);
        } catch(e) { console.error("Autocomplete load failed", e); }
    }

    function setupGhostText(inputId, dataSource) {
        const input = document.getElementById(inputId);
        
        input.addEventListener('keydown', function(e) {
            // If user hits Backspace, temporarily disable auto-suggest
            // so they can actually delete text without it fighting back
            if (e.key === 'Backspace') {
                input.dataset.backspacing = "true";
            } else {
                input.dataset.backspacing = "false";
            }
        });

        input.addEventListener('input', function(e) {
            const val = input.value;
            
            // Don't suggest if empty or backspacing
            if (!val || input.dataset.backspacing === "true") return;

            // Find match (Case Insensitive)
            // We escape special regex chars just in case
            const match = dataSource.find(item => item.toLowerCase().startsWith(val.toLowerCase()));
            
            if (match) {
                // If we found "John Smith" and user typed "jo", 
                // we want to preserve "jo" case (or not? Standard is to preserve case of match usually)
                // Let's use the match's case to be clean.
                
                const currentLen = val.length;
                
                // Set the value to the FULL match
                input.value = match;
                
                // Highlight the part the user HAS NOT typed yet
                // setSelectionRange(start, end)
                input.setSelectionRange(currentLen, match.length);
            }
        });
    }

    // --- 3. SUBMISSION & PLUGINS ---
    async function submitImport(e) {
        e.preventDefault();
        const id = document.getElementById('inp_id').value;
        
        // Grab values for autocomplete update
        const rawArtist = document.getElementById('inp_artist').value;
        const rawSeries = document.getElementById('inp_series').value;

        // 1. Find the index of the current file so we know what to select next
        // (Note: id from DOM is string, f.id is int, so use ==)
        const currentIndex = stagedFiles.findIndex(f => f.id == id);

        const payload = {
            title: document.getElementById('inp_title').value,
            artist: rawArtist,
            series: rawSeries,
            category: document.getElementById('inp_category').value,
            tags: document.getElementById('inp_tags').value.split(',').map(t=>t.trim()),
            description: document.getElementById('inp_desc').value,
            direction: document.getElementById('inp_direction').value
        };

        const btn = e.target.querySelector('.btn-save');
        const oldText = btn.innerText;
        btn.innerText = "Importing...";
        btn.disabled = true;

        try {
            const res = await fetch(`/api/import/${id}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            
            if (res.ok) {
                // 2. Remove imported file from list
                stagedFiles = stagedFiles.filter(f => f.id != id);
                renderList();

                // 3. Update Autocomplete
                if (rawArtist && !knownArtists.includes(rawArtist)) knownArtists.push(rawArtist);
                if (rawSeries && !knownSeries.includes(rawSeries)) knownSeries.push(rawSeries);

                // 4. Auto-select the next file
                if (stagedFiles.length > 0) {
                    // Try to grab the file that moved into the current slot
                    let nextIndex = currentIndex;
                    
                    // If we were at the end of the list, step back one
                    if (nextIndex >= stagedFiles.length) {
                        nextIndex = stagedFiles.length - 1;
                    }
                    
                    // Select the next file immediately
                    selectFile(stagedFiles[nextIndex].id);
                } else {
                    // List is empty, clear the UI
                    document.getElementById('import-form-container').style.display = 'none';
                    document.getElementById('preview-img').style.display = 'none';
                    document.getElementById('preview-placeholder').style.display = 'block';
                    document.getElementById('preview-filename').innerText = "All files imported!";
                }

            } else {
                alert("Import failed.");
            }
        } catch(e) { alert(e); }
        
        btn.innerText = oldText;
        btn.disabled = false;
    }

    // --- UTILS ---
    async function loadCategoryDropdown() {
        const res = await fetch('/api/categories');
        const cats = await res.json();
        const sel = document.getElementById('inp_category');
        sel.innerHTML = '<option value="">(None)</option>';
        cats.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.name;
            opt.innerText = c.name;
            sel.appendChild(opt);
        });
    }

    async function loadPluginDropdown() {
        try {
            const res = await fetch('/api/plugins');
            const plugins = await res.json();
            const select = document.getElementById('plugin_source');
            select.innerHTML = '<option value="" disabled selected>Select a plugin...</option>';
            
            if (plugins.length === 0) {
                const opt = document.createElement('option');
                opt.disabled = true;
                opt.innerText = "(No plugins installed)";
                select.appendChild(opt);
                return;
            }
            plugins.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.id;
                opt.innerText = p.name;
                select.appendChild(opt);
            });
        } catch (e) { console.error("Error loading plugins:", e); }
    }

    async function runPlugin() {
        const source = document.getElementById('plugin_source').value;
        const url = document.getElementById('plugin_url').value;
        const btn = event.target;
        const originalText = "Fetch"; 

        if (!source || !url) { alert("Select source & enter URL"); return; }

        btn.innerText = "Fetching...";
        btn.disabled = true;
        btn.style.backgroundColor = "#555";

        try {
            const res = await fetch('/api/plugins/run', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ plugin_id: source, url: url })
            });

            if (res.ok) {
                const data = await res.json();
                if(data.title) document.getElementById('inp_title').value = data.title;
                if(data.artist) document.getElementById('inp_artist').value = data.artist;
                if(data.description) document.getElementById('inp_desc').value = data.description;
                if(data.tags && Array.isArray(data.tags)) document.getElementById('inp_tags').value = data.tags.join(', ');
                
                btn.style.backgroundColor = "#2ecc71";
                btn.innerText = "Found!";
                setTimeout(() => { 
                    btn.innerText = originalText; 
                    btn.style.backgroundColor = "var(--accent)";
                    btn.disabled = false;
                }, 2000);
            } else {
                alert("Plugin Error");
                btn.innerText = originalText;
                btn.disabled = false;
                btn.style.backgroundColor = "var(--accent)";
            }
        } catch (e) {
            alert("System Error: " + e);
            btn.innerText = originalText;
            btn.disabled = false;
            btn.style.backgroundColor = "var(--accent)";
        }
    }
    
    // --- KEYBOARD SHORTCUTS ---
    function setupKeyboardShortcuts() {
        const urlInput = document.getElementById('plugin_url');
        if (urlInput) {
            urlInput.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault(); 
                    runPlugin(); 
                }
            });
        }
    }

    // Init
    loadFiles();
    loadCategoryDropdown();
    loadPluginDropdown();
    loadAutocomplete();
    setupKeyboardShortcuts();

</script>
{% endblock %}