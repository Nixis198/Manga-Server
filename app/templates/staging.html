{% extends "base.html" %}

{% block content %}
<div style="display: flex; height: calc(100vh - 80px); border: 1px solid #444; border-radius: 4px; overflow: hidden; background: #1e1e1e;">
    
    <div style="width: 280px; display: flex; flex-direction: column; background: #252525; border-right: 1px solid #444;">
        <div style="padding: 12px 15px; background: #1a1a1a; border-bottom: 1px solid #333; font-weight: bold; display: flex; justify-content: space-between; align-items: center;">
            <span>Staging Area</span>
            <button onclick="scanFiles()" class="btn-small" style="font-size: 0.8rem;">Rescan</button>
        </div>
        <div id="file-list" style="flex: 1; overflow-y: auto;">
            <div style="padding: 20px; color: #888; text-align: center;">Loading...</div>
        </div>
    </div>

    <div id="editor-area" style="flex: 1; display: none; flex-direction: column; position: relative;">
        
        <div style="flex: 1; overflow-y: auto; padding: 20px; display: flex; gap: 30px;">
            
            <div style="width: 300px; flex-shrink: 0; position: sticky; top: 0; height: fit-content;">
                <div style="background: #000; border: 1px solid #444; border-radius: 8px; overflow: hidden; aspect-ratio: 2/3; display: flex; align-items: center; justify-content: center; margin-bottom: 15px;">
                    <img id="preview-img" style="max-width: 100%; max-height: 100%; object-fit: contain;">
                </div>
                
                <div style="background: #252525; padding: 15px; border-radius: 6px; border: 1px solid #444;">
                    <div style="font-size: 0.75rem; color: #aaa; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px;">Filename</div>
                    <div id="preview-filename" style="word-break: break-all; font-family: monospace; font-size: 0.9rem; color: #ddd; line-height: 1.4;">-</div>
                </div>
            </div>

            <div style="flex: 1; max-width: 800px;">
                
                <form id="import-form" onsubmit="submitImport(event)">
                    <input type="hidden" id="inp_id">
                    <button type="submit" style="display: none;"></button>
                    
                    <div style="margin-bottom: 15px;">
                        <label class="form-label">Title</label>
                        <input type="text" id="inp_title" required class="form-input" style="font-size: 1.1rem; font-weight: bold;">
                    </div>

                    <div class="form-grid">
                        <div>
                            <label class="form-label">Artist</label>
                            <input type="text" id="inp_artist" required autocomplete="off" class="form-input">
                        </div>
                        <div>
                            <label class="form-label">Series <span style="color:#666; font-weight:normal;">(Optional)</span></label>
                            <input type="text" id="inp_series" autocomplete="off" class="form-input">
                        </div>
                    </div>

                    <div class="form-grid" style="margin-top: 15px;">
                        <div>
                            <label class="form-label">Category</label>
                            <select id="inp_category" class="form-input">
                                <option value="">(None)</option>
                            </select>
                        </div>
                        <div>
                             <label class="form-label">Reading Direction</label>
                             <select id="inp_direction" class="form-input">
                                 <option value="LTR">Left to Right (Comic)</option>
                                 <option value="RTL">Right to Left (Manga)</option>
                             </select>
                        </div>
                    </div>

                    <div style="margin-top: 15px;">
                        <label class="form-label">Tags</label>
                        <input type="text" id="inp_tags" placeholder="Comma, separated, tags" class="form-input">
                    </div>

                    <div style="margin-top: 15px; margin-bottom: 20px;">
                        <label class="form-label">Description</label>
                        <textarea id="inp_desc" rows="3" class="form-input" style="font-size: 0.9rem;"></textarea>
                    </div>

                    <div style="background: #2a2a2a; border: 1px solid #444; border-radius: 6px; padding: 10px; margin-bottom: 10px; display: flex; gap: 10px; align-items: center;">
                        <div style="font-weight: bold; color: var(--accent); white-space: nowrap;">âš¡ Metadata Source:</div>
                        <select id="plugin_source" style="flex: 1; min-width: 120px;">
                            <option value="" disabled selected>Select Plugin...</option>
                        </select>
                        <input type="text" id="plugin_url" placeholder="Paste URL or ID..." style="flex: 2;">
                        <button type="button" onclick="runPlugin()" class="btn-small" style="background: #34495e;">Fetch</button>
                    </div>

                </form>
            </div>
        </div>

        <div style="padding: 15px 20px; background: #252525; border-top: 1px solid #444; text-align: right; box-shadow: 0 -4px 10px rgba(0,0,0,0.2);">
            <button onclick="document.getElementById('import-form').requestSubmit()" class="btn-save" style="padding: 10px 40px; font-size: 1.1rem;">
                Save & Import
            </button>
        </div>

    </div>
    
    <div id="empty-state" style="flex: 1; display: flex; align-items: center; justify-content: center; color: #666; flex-direction: column;">
        <div style="font-size: 3rem; margin-bottom: 10px;">ðŸ“‚</div>
        <div>Select a file to begin editing</div>
    </div>
</div>

<style>
    /* UTILITIES */
    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
    }
    .form-label {
        display: block; 
        color: #aaa; 
        margin-bottom: 5px; 
        font-size: 0.85rem;
        font-weight: 500;
    }
    .form-input {
        width: 100%; 
        padding: 10px;
        background: #111; 
        border: 1px solid #444; 
        color: white; 
        border-radius: 4px;
        transition: border-color 0.2s;
    }
    .form-input:focus {
        border-color: var(--accent);
        outline: none;
    }

    /* FILE LIST ITEMS */
    .file-item {
        padding: 12px 15px;
        border-bottom: 1px solid #333;
        cursor: pointer;
        font-size: 0.9rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        transition: background 0.1s;
    }
    .file-item:hover { background: #333; }
    .file-item.active { background: var(--accent); color: white; border-bottom-color: var(--accent); }
    
    textarea { resize: vertical; }
</style>

<script>
    let stagedFiles = [];
    let knownArtists = [];
    let knownSeries = [];

    // --- 1. CORE LOADING LOGIC ---
    async function loadFiles() {
        const res = await fetch('/api/staged');
        stagedFiles = await res.json();
        renderList();
    }

    async function scanFiles() {
        document.getElementById('file-list').innerHTML = '<div style="padding:20px; text-align:center;">Scanning...</div>';
        await fetch('/api/scan', { method: 'POST' });
        loadFiles();
    }

    function renderList() {
        const list = document.getElementById('file-list');
        list.innerHTML = '';
        if (stagedFiles.length === 0) {
            list.innerHTML = '<div style="padding:20px; color:#888; text-align:center;">No files found.</div>';
            return;
        }

        stagedFiles.forEach(f => {
            const div = document.createElement('div');
            div.className = 'file-item';
            div.innerText = f.filename;
            div.onclick = () => selectFile(f.id);
            div.dataset.id = f.id; 
            list.appendChild(div);
        });
    }

    async function selectFile(id) {
        document.querySelectorAll('.file-item').forEach(el => el.classList.remove('active'));
        const activeEl = document.querySelector(`.file-item[data-id="${id}"]`);
        if(activeEl) activeEl.classList.add('active');

        const file = stagedFiles.find(f => f.id === id);
        if (!file) return;

        document.getElementById('empty-state').style.display = 'none';
        document.getElementById('editor-area').style.display = 'flex';
        
        document.getElementById('preview-filename').innerText = file.filename;
        const img = document.getElementById('preview-img');
        img.src = `/api/staged/${id}/cover`;

        document.getElementById('inp_id').value = id;
        
        // Auto-fill
        let title = file.filename;
        let artist = "";
        const match = title.match(/^\[(.*?)\]\s*(.*?)(\.zip|\.cbz)?$/);
        if (match) {
            artist = match[1];
            title = match[2];
            title = title.replace(/\s*\(.*?\)\s*/g, '').trim();
        } else {
            title = title.replace(/\.(zip|cbz)$/i, '');
        }

        const titleInput = document.getElementById('inp_title');
        titleInput.value = title;
        document.getElementById('inp_artist').value = artist;
        document.getElementById('inp_series').value = "";
        document.getElementById('inp_tags').value = "";
        document.getElementById('inp_desc').value = "";
        document.getElementById('plugin_url').value = ""; 

        titleInput.focus();
        titleInput.select();
    }

    // --- 2. GHOST TEXT AUTOCOMPLETE ---
    async function loadAutocomplete() {
        try {
            const res = await fetch('/api/autocomplete');
            const data = await res.json();
            knownArtists = data.artists || [];
            knownSeries = data.series || [];
            
            setupGhostText('inp_artist', knownArtists);
            setupGhostText('inp_series', knownSeries);
        } catch(e) { console.error("Autocomplete load failed", e); }
    }

    function setupGhostText(inputId, dataSource) {
        const input = document.getElementById(inputId);
        
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Backspace') {
                input.dataset.backspacing = "true";
            } else {
                input.dataset.backspacing = "false";
            }
        });

        input.addEventListener('input', function(e) {
            const val = input.value;
            if (!val || input.dataset.backspacing === "true") return;
            
            // Find match (Case Insensitive)
            const match = dataSource.find(item => item.toLowerCase().startsWith(val.toLowerCase()));
            
            if (match) {
                const currentLen = val.length;
                
                // FIX: Instead of replacing the input with the match (which forces casing),
                // we append the missing suffix from the match to the user's existing input.
                // This preserves user's capitalization (e.g. "Kar" + "ory" -> "Karory")
                const suffix = match.slice(currentLen);
                input.value = val + suffix;
                
                input.setSelectionRange(currentLen, input.value.length);
            }
        });
    }

    // --- 3. SUBMISSION ---

    async function submitImport(e) {
        e.preventDefault();
        const id = document.getElementById('inp_id').value;
        const rawArtist = document.getElementById('inp_artist').value;
        const rawSeries = document.getElementById('inp_series').value;
        const currentIndex = stagedFiles.findIndex(f => f.id == id);

        const payload = {
            title: document.getElementById('inp_title').value,
            artist: rawArtist,
            series: rawSeries,
            category: document.getElementById('inp_category').value,
            tags: document.getElementById('inp_tags').value.split(',').map(t=>t.trim()),
            description: document.getElementById('inp_desc').value,
            direction: document.getElementById('inp_direction').value
        };

        const btn = document.querySelector('.btn-save');
        const oldText = btn.innerText;
        btn.innerText = "Importing...";
        btn.disabled = true;

        try {
            const res = await fetch(`/api/import/${id}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            
            if (res.ok) {
                stagedFiles = stagedFiles.filter(f => f.id != id);
                renderList();

                if (rawArtist && !knownArtists.includes(rawArtist)) knownArtists.push(rawArtist);
                if (rawSeries && !knownSeries.includes(rawSeries)) knownSeries.push(rawSeries);

                if (stagedFiles.length > 0) {
                    let nextIndex = currentIndex;
                    if (nextIndex >= stagedFiles.length) nextIndex = stagedFiles.length - 1;
                    selectFile(stagedFiles[nextIndex].id);
                } else {
                    document.getElementById('editor-area').style.display = 'none';
                    document.getElementById('empty-state').style.display = 'flex';
                    document.getElementById('empty-state').innerHTML = '<div>All files imported!</div>';
                }

            } else {
                alert("Import failed.");
            }
        } catch(e) { alert(e); }
        
        btn.innerText = oldText;
        btn.disabled = false;
    }

    // --- UTILS ---
    async function loadCategoryDropdown() {
        const res = await fetch('/api/categories');
        const cats = await res.json();
        const sel = document.getElementById('inp_category');
        sel.innerHTML = '<option value="">(None)</option>';
        cats.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.name;
            opt.innerText = c.name;
            sel.appendChild(opt);
        });
    }

    async function loadPluginDropdown() {
        try {
            const res = await fetch('/api/plugins');
            const plugins = await res.json();
            const select = document.getElementById('plugin_source');
            select.innerHTML = '<option value="" disabled selected>Select Plugin...</option>';
            
            if (plugins.length === 0) {
                const opt = document.createElement('option');
                opt.disabled = true;
                opt.innerText = "(No plugins installed)";
                select.appendChild(opt);
                return;
            }
            plugins.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.id;
                opt.innerText = p.name;
                select.appendChild(opt);
            });
        } catch (e) { console.error(e); }
    }

    async function runPlugin() {
        const source = document.getElementById('plugin_source').value;
        const url = document.getElementById('plugin_url').value;
        const btn = event.target;
        const originalText = "Fetch"; 

        if (!source || !url) { alert("Select source & enter URL"); return; }

        btn.innerText = "...";
        btn.disabled = true;

        try {
            const res = await fetch('/api/plugins/run', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ plugin_id: source, url: url })
            });

            if (res.ok) {
                const data = await res.json();
                if(data.title) document.getElementById('inp_title').value = data.title;
                if(data.artist) document.getElementById('inp_artist').value = data.artist;
                if(data.description) document.getElementById('inp_desc').value = data.description;
                if(data.tags && Array.isArray(data.tags)) document.getElementById('inp_tags').value = data.tags.join(', ');
                
                btn.style.backgroundColor = "#2ecc71";
                btn.innerText = "âœ“";
                setTimeout(() => { 
                    btn.innerText = originalText; 
                    btn.style.backgroundColor = "#34495e";
                    btn.disabled = false;
                }, 1500);
            } else {
                alert("Plugin Error");
                btn.innerText = originalText;
                btn.disabled = false;
            }
        } catch (e) {
            alert("Error: " + e);
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }
    
    // --- KEYBOARD SHORTCUTS ---
    function setupKeyboardShortcuts() {
        const urlInput = document.getElementById('plugin_url');
        if (urlInput) {
            urlInput.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault(); 
                    runPlugin(); 
                }
            });
        }

        const descInput = document.getElementById('inp_desc');
        if (descInput) {
            descInput.addEventListener('keydown', function(event) {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault(); 
                    document.getElementById('import-form').requestSubmit(); 
                }
            });
        }
    }

    // Init
    loadFiles();
    loadCategoryDropdown();
    loadPluginDropdown();
    loadAutocomplete();
    setupKeyboardShortcuts();

</script>
{% endblock %}