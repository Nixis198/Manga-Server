{% extends "base.html" %}

{% block title %}{{ series.name }}{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

<div class="series-container">
    
    <div class="header-row">
        <div class="header-info">
            <a href="/" class="back-link">&larr; Back to Library</a>
            <h1>{{ series.name }}</h1>
            {% if series.description %}
            <p class="series-desc">{{ series.description }}</p>
            {% endif %}
        </div>
        <button class="btn-small header-btn" onclick="toggleSeriesSettings()">Series Settings</button>
    </div>

    <div id="series-settings" class="settings-panel">
        <h3>Series Settings</h3>
        
        <div class="settings-content">
            <div class="settings-cover">
                <img id="setting-preview-img" src="{{ cover_url }}">
            </div>

            <div class="settings-form">
                <div style="margin-bottom: 15px;">
                    <label>Series Name</label>
                    <input type="text" id="inp_name" value="{{ series.name }}">
                </div>

                <div style="margin-bottom: 15px;">
                    <label>Series Thumbnail</label>
                    <select id="inp_thumb" onchange="updatePreview(this)">
                        <option value="">(Default - First Gallery)</option>
                        <option value="__reading__" {% if series.thumbnail_url == '__reading__' %}selected{% endif %}>
                            (Auto - Currently Reading)
                        </option>
                        {% for g in galleries %}
                        <option value="/thumbnails/{{g.id}}.jpg" {% if series.thumbnail_url == '/thumbnails/' ~ g.id ~ '.jpg' %}selected{% endif %}>
                            {{ g.title }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label>Description</label>
                    <textarea id="inp_desc" rows="3">{{ series.description }}</textarea>
                </div>
            </div>
        </div>

        <div class="settings-actions">
            <button class="btn-small btn-reorder" onclick="toggleReorderMode()">Manage Sort Order</button>
            <button class="btn-save" onclick="saveSeriesSettings()">Save Settings</button>
        </div>

        <div id="reorder-tool" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid #444;">
            <div style="background: #222; padding: 15px; border-radius: 5px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; flex-wrap:wrap; gap:10px;">
                    <strong style="color: #fff;">Drag and Drop Mode Active</strong>
                    <button class="btn-small" onclick="saveOrder()" style="background: var(--accent);">Save New Order</button>
                </div>
                
                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <span style="color: #aaa; font-size: 0.9rem;">Quick Sort:</span>
                    <button class="btn-small" onclick="autoSort('title')">By Title</button>
                    <button class="btn-small" onclick="autoSort('filename')">By Filename</button>
                </div>
                
                <div style="font-size: 0.8rem; color: #888; margin-top: 10px;">
                    Drag items to reorder. The numbers will update automatically. Click "Save New Order" when done.
                </div>
            </div>
        </div>
    </div>

    <div class="grid" id="series-grid">
        {% for gallery in galleries %}
        <div class="card" 
             data-id="{{ gallery.id }}"
             data-title="{{ gallery.title }}"
             data-filename="{{ gallery.filename }}"
             data-artist="{{ gallery.artist }}"
             data-series="{{ series.name }}"
             data-status="{{ gallery.status }}"
             data-category="{{ gallery.category.name if gallery.category else '' }}"
             data-tags="{{ gallery.tags|map(attribute='name')|join(', ') }}" 
             data-desc="{{ gallery.description }}"
             onclick="window.location.href='/reader/{{ gallery.id }}'">
            
            <img src="/thumbnails/{{ gallery.id }}.jpg" loading="lazy" alt="Cover">
            
            <div class="card-body">
                <div class="card-title">{{ gallery.title }}</div>
                
                <div style="margin-top: 5px; display: flex; justify-content: space-between; align-items: center;">
                    <div class="card-artist">{{ gallery.artist }}</div>
                    
                    <div class="sort-ui" onclick="event.stopPropagation()" style="display: none;">
                        <input type="text" class="sort-input" value="{{ gallery.sort_order }}" disabled
                               style="width: 30px; padding: 4px; background: #333; border: 1px solid #555; color: #fff; text-align: center; font-weight:bold; border-radius:50%;">
                    </div>

                    <div class="badges-ui" style="display: flex; gap: 4px;">
                        {% if gallery.status == 'Completed' %}
                             <span class="badge status-completed" style="float:none;">Completed</span>
                        {% elif gallery.pages_read > 1 %}
                            <span class="badge status-reading" style="float:none;">{{ gallery.pages_read }} / {{ gallery.pages_total }}</span>
                        {% else %}
                            <span class="badge status-new" style="float:none;">New</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <div id="context-menu" style="display:none; position:absolute; z-index:1000; background:#333; border:1px solid #555; border-radius:4px; box-shadow:0 2px 10px rgba(0,0,0,0.5);">
        <div class="ctx-item" onclick="openReaderFromCtx()">Read</div>
        <div class="ctx-item" onclick="openEditModal()">Edit Metadata</div>
        <div class="ctx-item" onclick="markAsReadCtx()">Mark as Read</div>
        <div class="ctx-item" onclick="downloadGalleryFromCtx()">Download</div>
        <div class="ctx-item" onclick="deleteGalleryCtx()" style="color: #e74c3c;">Delete</div>
    </div>

    <div id="edit-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:2000; justify-content:center; align-items:center;">
        <div style="background:#2d2d2d; padding:20px; border-radius:8px; width:500px; max-width:90%;">
            <h2>Edit Metadata</h2>
            <input type="hidden" id="edit_id">
            
            <div style="margin-bottom:10px;">
                <label style="display:block; color:#aaa; font-size:0.8rem;">Title</label>
                <input type="text" id="edit_title" style="width:100%; padding:8px; background:#1a1a1a; border:1px solid #444; color:white;">
            </div>
            
            <div style="margin-bottom:10px;">
                <label style="display:block; color:#aaa; font-size:0.8rem;">Artist</label>
                <input type="text" id="edit_artist" style="width:100%; padding:8px; background:#1a1a1a; border:1px solid #444; color:white;">
            </div>

            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <div style="flex:1;">
                    <label style="display:block; color:#aaa; font-size:0.8rem;">Category</label>
                    <select id="edit_category" style="width:100%; padding:8px; background:#1a1a1a; border:1px solid #444; color:white;">
                        <option value="">(None)</option>
                    </select>
                </div>
                <div style="flex:1;">
                    <label style="display:block; color:#aaa; font-size:0.8rem;">Series</label>
                    <input type="text" id="edit_series" style="width:100%; padding:8px; background:#1a1a1a; border:1px solid #444; color:white;">
                </div>
            </div>

            <div style="margin-bottom:10px;">
                <label style="display:block; color:#aaa; font-size:0.8rem;">Tags</label>
                <input type="text" id="edit_tags" style="width:100%; padding:8px; background:#1a1a1a; border:1px solid #444; color:white;">
            </div>

            <div style="margin-bottom:10px;">
                <label style="display:block; color:#aaa; font-size:0.8rem;">Description</label>
                <textarea id="edit_desc" rows="3" style="width:100%; padding:8px; background:#1a1a1a; border:1px solid #444; color:white;"></textarea>
            </div>
            
            <div style="text-align:right; margin-top:20px;">
                <button onclick="closeEditModal()" style="background:#555; color:white; border:none; padding:8px 15px; cursor:pointer; margin-right:10px;">Cancel</button>
                <button onclick="saveEdit()" style="background:#2ecc71; color:white; border:none; padding:8px 15px; cursor:pointer;">Save Changes</button>
            </div>
        </div>
    </div>

</div>

<style>
    /* --- BASE LAYOUT --- */
    .series-container { padding: 20px; }
    
    .header-row {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 20px;
    }
    
    .back-link { color: #888; text-decoration: none; }
    .series-desc { color: #aaa; margin: 10px 0 0 0; max-width: 800px; line-height: 1.4; }
    h1 { margin: 5px 0; }

    /* SETTINGS PANEL */
    .settings-panel {
        display: none;
        background: #2d2d2d;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 1px solid #444;
    }
    .settings-content { display: flex; gap: 30px; flex-wrap: wrap; }
    
    .settings-cover { width: 200px; text-align: center; }
    .settings-cover img { 
        width: 100%; 
        border-radius: 4px; 
        box-shadow: 0 4px 8px rgba(0,0,0,0.5); 
        margin-bottom: 10px; 
    }
    
    .settings-form { flex: 1; min-width: 250px; }
    .settings-form label { display: block; color: #aaa; margin-bottom: 5px; }
    .settings-form input, .settings-form select, .settings-form textarea {
        width: 100%;
        padding: 8px;
        background: #1a1a1a;
        border: 1px solid #444;
        color: white;
        box-sizing: border-box; 
    }

    .settings-actions {
        margin-top: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-top: 1px solid #444;
        padding-top: 15px;
        flex-wrap: wrap;
        gap: 10px;
    }

    .btn-reorder { background: #e67e22; }
    .sortable-ghost { opacity: 0.4; background-color: var(--accent); }
    .sortable-drag { cursor: grabbing; }

    /* CONTEXT MENU */
    .ctx-item { padding: 10px 20px; cursor: pointer; color: #e0e0e0; }
    .ctx-item:hover { background-color: var(--accent, #3498db); color: white; }

    /* --- MOBILE OPTIMIZATION --- */
    @media (max-width: 768px) {
        .series-container { padding: 10px; }

        /* 1. Stack Header Info & Button */
        .header-row {
            flex-direction: column;
            gap: 15px;
        }
        .header-btn {
            width: 100%;
        }

        /* 2. Stack Settings Panel */
        .settings-content {
            flex-direction: column;
        }
        .settings-cover {
            width: 100%;
            max-width: 200px;
            margin: 0 auto;
        }

        .settings-actions {
            flex-direction: column;
        }
        .settings-actions button {
            width: 100%;
        }

        /* 3. Grid: 2 Columns on Mobile */
        .grid {
            grid-template-columns: repeat(2, 1fr) !important;
            gap: 10px !important;
        }

        /* 4. Fix Thumbnail Aspect Ratio */
        .card img {
            height: auto !important;
            aspect-ratio: 2 / 3;
            object-fit: cover;
        }
        
        /* 5. Smaller Fonts */
        h1 { font-size: 1.5rem !important; }
        .card-title { font-size: 0.85rem !important; }
        .card-artist { font-size: 0.75rem !important; }
        .badge { font-size: 0.7rem !important; }
    }
</style>

<script>
    // --- VARIABLES ---
    // LINTER FIX: define ID as a string first
    const SERIES_ID = "{{ series.id }}";
    
    let sortableInstance = null;
    let initialOrder = []; 
    const gridEl = document.getElementById('series-grid');

    // --- 1. DATA FOR PREVIEW LOGIC ---
    const seriesData = Array.from(document.querySelectorAll('.card')).map(card => {
        return {
            id: parseInt(card.dataset.id),
            status: card.dataset.status, 
            thumb: `/thumbnails/${card.dataset.id}.jpg`
        };
    });

    function updatePreview(selectElement) {
        const val = selectElement.value;
        const img = document.getElementById('setting-preview-img');
        let newSrc = "";

        if (val === "__reading__") {
            const readingGal = seriesData.find(g => g.status === "Reading");
            newSrc = readingGal ? readingGal.thumb : (seriesData[0] ? seriesData[0].thumb : '');
        } 
        else if (val === "") {
            if (seriesData.length > 0) newSrc = seriesData[0].thumb;
        } 
        else {
            newSrc = val;
        }

        if (newSrc) img.src = newSrc;
    }

    // --- SERIES SETTINGS TOGGLE ---
    function toggleSeriesSettings() {
        const el = document.getElementById('series-settings');
        const isClosing = el.style.display === 'block';

        if (isClosing) {
            const tool = document.getElementById('reorder-tool');
            if (tool.style.display === 'block') {
                cancelReorder();
            }
        }
        el.style.display = isClosing ? 'none' : 'block';
    }

    async function saveSeriesSettings() {
        const name = document.getElementById('inp_name').value;
        const thumb = document.getElementById('inp_thumb').value;
        const desc = document.getElementById('inp_desc').value;

        // FIXED: Use backticks and the variable to keep linter happy
        const res = await fetch(`/api/series/${SERIES_ID}/update`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ name: name, thumbnail_url: thumb, description: desc })
        });
        if(res.ok) location.reload();
    }

    // --- DRAG AND DROP LOGIC ---
    function toggleReorderMode() {
        const tool = document.getElementById('reorder-tool');
        const inputs = document.querySelectorAll('.sort-ui');
        const badges = document.querySelectorAll('.badges-ui');
        const cards = document.querySelectorAll('.card');

        const isVisible = tool.style.display === 'block';

        if (isVisible) {
            cancelReorder();
        } else {
            initialOrder = Array.from(gridEl.children);
            tool.style.display = 'block';
            inputs.forEach(el => el.style.display = 'block');
            badges.forEach(el => el.style.display = 'none');
            cards.forEach(c => c.style.cursor = 'move');

            sortableInstance = new Sortable(gridEl, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                onEnd: function (evt) { updateVisualNumbers(); }
            });
            updateVisualNumbers();
        }
    }

    function cancelReorder() {
        if (initialOrder.length > 0) {
            initialOrder.forEach(card => gridEl.appendChild(card));
        }
        document.getElementById('reorder-tool').style.display = 'none';
        document.querySelectorAll('.sort-ui').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.badges-ui').forEach(el => el.style.display = 'flex');

        if (sortableInstance) {
            sortableInstance.destroy();
            sortableInstance = null;
        }
        document.querySelectorAll('.card').forEach(c => c.style.cursor = 'pointer');
        updateVisualNumbers();
    }

    function updateVisualNumbers() {
        const rows = document.querySelectorAll('.card');
        rows.forEach((row, index) => {
            const input = row.querySelector('.sort-input');
            input.value = index + 1;
        });
    }

    function autoSort(key) {
        if (!confirm(`This will reorder the visible cards by ${key}. You still need to click Save.`)) return;
        const cards = Array.from(document.querySelectorAll('.card'));
        cards.sort((a, b) => {
            let valA = a.dataset[key].toLowerCase();
            let valB = b.dataset[key].toLowerCase();
            if (valA < valB) return -1;
            if (valA > valB) return 1;
            return 0;
        });
        cards.forEach(card => gridEl.appendChild(card));
        updateVisualNumbers();
    }

    async function saveOrder() {
        const cards = document.querySelectorAll('.card');
        const idList = [];
        cards.forEach(card => {
            idList.push(parseInt(card.dataset.id));
        });

        // FIXED: Use backticks and variable
        const res = await fetch(`/api/series/${SERIES_ID}/update`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ order: idList })
        });
        if(res.ok) location.reload();
    }

    // --- CONTEXT MENU LOGIC ---
    let selectedGallery = null;

    document.addEventListener('contextmenu', event => {
        const card = event.target.closest('.card');
        if (card) {
            event.preventDefault();
            selectedGallery = { id: card.dataset.id };
            const menu = document.getElementById('context-menu');
            menu.style.display = 'block';
            menu.style.left = `${event.pageX}px`;
            menu.style.top = `${event.pageY}px`;
        } else {
            document.getElementById('context-menu').style.display = 'none';
        }
    });

    document.addEventListener('click', () => {
        document.getElementById('context-menu').style.display = 'none';
    });

    function openReaderFromCtx() {
        if(selectedGallery) window.location.href = `/reader/${selectedGallery.id}`;
    }

    function downloadGalleryFromCtx() {
        if(selectedGallery) {
            window.location.href = `/api/download/${selectedGallery.id}`;
        }
    }

    async function deleteGalleryCtx() {
        if(!selectedGallery) return;
        if(!confirm("Are you sure you want to delete this gallery?\nThis will permanently remove the file.")) return;
        
        try {
            const res = await fetch(`/api/gallery/${selectedGallery.id}`, { method: 'DELETE' });
            const data = await res.json();
            
            if(res.ok) {
                if (data.series_deleted) {
                    alert("Series is empty and has been deleted.");
                    window.location.href = "/";
                } else {
                    location.reload();
                }
            } else {
                alert("Failed to delete.");
            }
        } catch(e) {
            alert("Error deleting.");
        }
    }

    // --- EDIT MODAL LOGIC ---
    async function openEditModal() {
        if(!selectedGallery) return;
        
        const res = await fetch('/api/categories');
        const cats = await res.json();
        const select = document.getElementById('edit_category');
        select.innerHTML = '<option value="">(None)</option>';
        cats.forEach(cat => {
            const opt = document.createElement('option');
            opt.value = cat.name;
            opt.innerText = cat.name;
            select.appendChild(opt);
        });

        const card = document.querySelector(`.card[data-id="${selectedGallery.id}"]`);
        document.getElementById('edit_id').value = selectedGallery.id;
        document.getElementById('edit_title').value = card.dataset.title;
        document.getElementById('edit_artist').value = card.dataset.artist;
        document.getElementById('edit_series').value = card.dataset.series;
        document.getElementById('edit_category').value = card.dataset.category;
        document.getElementById('edit_tags').value = card.dataset.tags;
        document.getElementById('edit_desc').value = card.dataset.desc;

        document.getElementById('edit-modal').style.display = 'flex';
    }

    function closeEditModal() {
        document.getElementById('edit-modal').style.display = 'none';
    }

    async function saveEdit() {
        const id = document.getElementById('edit_id').value;
        const payload = {
            title: document.getElementById('edit_title').value,
            artist: document.getElementById('edit_artist').value,
            series: document.getElementById('edit_series').value,
            category: document.getElementById('edit_category').value,
            tags: document.getElementById('edit_tags').value.split(',').map(t=>t.trim()),
            description: document.getElementById('edit_desc').value,
            direction: "LTR" 
        };

        await fetch(`/api/gallery/${id}/update`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        location.reload(); 
    }

    async function markAsReadCtx() {
        if(!selectedGallery) return;
        
        if(confirm("Mark gallery as read?")) {
            const res = await fetch(`/api/gallery/${selectedGallery.id}/mark-read`, { method: 'POST' });
            if(res.ok) location.reload();
        }
    }
</script>
{% endblock %}