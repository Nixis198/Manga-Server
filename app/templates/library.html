{% extends "base.html" %}

{% block content %}
    <div style="margin-bottom: 20px; display: flex; justify-content: space-between;">
        <h1>Library</h1>
        <input type="text" id="search" placeholder="Search title, artist..." 
               style="padding: 10px; border-radius: 5px; border: 1px solid #555; background: #333; color: white; width: 300px;">
    </div>

    <div id="filter-bar" class="filter-bar">
        <button class="filter-btn active" onclick="filterByCategory('all', this)">All</button>
        </div>

    <div class="grid" id="gallery-grid">
        {% for gallery in galleries %}
        <div class="card" 
             data-id="{{ gallery.id }}"
             data-title="{{ gallery.title }}"
             data-artist="{{ gallery.artist }}"
             data-series="{{ gallery.series.name if gallery.series else '' }}"
             data-category="{{ gallery.category.name if gallery.category else '' }}"
             data-tags="{{ gallery.tags|map(attribute='name')|join(', ') }}"
             data-desc="{{ gallery.description }}"
             onclick="window.location.href='/reader/{{ gallery.id }}'">
            
            <img src="/thumbnails/{{ gallery.id }}.jpg" loading="lazy" alt="Cover">
            <div class="card-body">
                {% if gallery.category %}
                <span class="badge" style="float:right; background:#555;">{{ gallery.category.name }}</span>
                {% endif %}
                
                <span class="badge status-{{ gallery.status|lower }}">{{ gallery.status }}</span>
                <div class="card-title" title="{{ gallery.title }}">{{ gallery.title }}</div>
                <div class="card-artist">{{ gallery.artist }}</div>
            </div>
        </div>
        {% endfor %}
    </div>

    <div id="context-menu" style="display:none; position:fixed; z-index:1000; background:#333; border:1px solid #555; border-radius:4px; box-shadow:0 2px 10px rgba(0,0,0,0.5);">
        <div class="ctx-item" onclick="openReaderFromCtx()">Read</div>
        <div class="ctx-item" onclick="openEditModal()">Edit Metadata</div>
    </div>

    <div id="edit-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:2000; justify-content:center; align-items:center;">
        <div style="background:#2d2d2d; padding:20px; border-radius:8px; width:500px; max-width:90%;">
            <h2>Edit Metadata</h2>
            <input type="hidden" id="edit_id">
            
            <div style="margin-bottom:10px;">
                <label style="display:block; color:#aaa; font-size:0.8rem;">Title</label>
                <input type="text" id="edit_title" style="width:100%; padding:8px; background:#1a1a1a; border:1px solid #444; color:white;">
            </div>
            
            <div style="margin-bottom:10px;">
                <label style="display:block; color:#aaa; font-size:0.8rem;">Artist</label>
                <input type="text" id="edit_artist" style="width:100%; padding:8px; background:#1a1a1a; border:1px solid #444; color:white;">
            </div>

            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <div style="flex:1;">
                    <label style="display:block; color:#aaa; font-size:0.8rem;">Category</label>
                    <select id="edit_category" style="width:100%; padding:8px; background:#1a1a1a; border:1px solid #444; color:white;">
                        <option value="">(None)</option>
                    </select>
                </div>
                <div style="flex:1;">
                    <label style="display:block; color:#aaa; font-size:0.8rem;">Series</label>
                    <input type="text" id="edit_series" style="width:100%; padding:8px; background:#1a1a1a; border:1px solid #444; color:white;">
                </div>
            </div>

            <div style="margin-bottom:10px;">
                <label style="display:block; color:#aaa; font-size:0.8rem;">Tags</label>
                <input type="text" id="edit_tags" style="width:100%; padding:8px; background:#1a1a1a; border:1px solid #444; color:white;">
            </div>

            <div style="margin-bottom:10px;">
                <label style="display:block; color:#aaa; font-size:0.8rem;">Description</label>
                <textarea id="edit_desc" rows="3" style="width:100%; padding:8px; background:#1a1a1a; border:1px solid #444; color:white;"></textarea>
            </div>
            
            <div style="text-align:right; margin-top:20px;">
                <button onclick="closeEditModal()" style="background:#555; color:white; border:none; padding:8px 15px; cursor:pointer; margin-right:10px;">Cancel</button>
                <button onclick="saveEdit()" style="background:#2ecc71; color:white; border:none; padding:8px 15px; cursor:pointer;">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. SEARCH LOGIC ---
        document.getElementById('search').addEventListener('keyup', function(e) {
            const term = e.target.value.toLowerCase();
            const cards = document.querySelectorAll('.card');
            
            cards.forEach(card => {
                const title = card.querySelector('.card-title').innerText.toLowerCase();
                const artist = card.querySelector('.card-artist').innerText.toLowerCase();
                
                // Only filter visible cards (respecting category filter)
                if (title.includes(term) || artist.includes(term)) {
                    // Check if category filter allows showing this
                    const activeFilter = document.querySelector('.filter-btn.active').innerText;
                    const cardCat = card.dataset.category || "";
                    
                    if (activeFilter === "All") card.style.display = 'block';
                    else if (activeFilter === "Uncategorized" && cardCat === "") card.style.display = 'block';
                    else if (activeFilter === cardCat) card.style.display = 'block';
                    else card.style.display = 'none';
                    
                } else {
                    card.style.display = 'none';
                }
            });
        });

        // --- 2. CATEGORY FILTER LOGIC ---
        async function loadCategoryFilters() {
            const container = document.getElementById('filter-bar');
            
            // Fetch Data
            const [catRes, setRes] = await Promise.all([
                fetch('/api/categories'),
                fetch('/api/settings')
            ]);
            
            const cats = await catRes.json();
            const settings = await setRes.json();
            const showUncategorized = (settings.show_uncategorized === "true");

            // Check if uncategorized items exist
            let hasUncategorized = false;
            document.querySelectorAll('.card').forEach(card => {
                if (!card.dataset.category) hasUncategorized = true;
            });

            // Create Buttons
            cats.forEach(cat => {
                const btn = document.createElement('button');
                btn.className = 'filter-btn';
                btn.innerText = cat.name;
                btn.onclick = () => filterByCategory(cat.name, btn);
                container.appendChild(btn);
            });

            if (showUncategorized && hasUncategorized) {
                const btn = document.createElement('button');
                btn.className = 'filter-btn';
                btn.innerText = "Uncategorized";
                btn.style.borderColor = "#666";
                btn.style.borderStyle = "dashed";
                btn.onclick = () => filterByCategory('__none__', btn);
                container.appendChild(btn);
            }
        }

        function filterByCategory(categoryName, btnElement) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btnElement.classList.add('active');

            const cards = document.querySelectorAll('.card');
            cards.forEach(card => {
                const cardCat = card.dataset.category || ""; 
                
                if (categoryName === 'all') {
                    card.style.display = 'block';
                } else if (categoryName === '__none__') {
                    card.style.display = (cardCat === "") ? 'block' : 'none';
                } else {
                    card.style.display = (cardCat === categoryName) ? 'block' : 'none';
                }
            });
        }

        // --- 3. CONTEXT MENU & EDIT LOGIC ---
        let selectedGallery = null;

        document.addEventListener('contextmenu', event => {
            const card = event.target.closest('.card');
            if (card) {
                event.preventDefault();
                selectedGallery = { id: card.dataset.id };
                const menu = document.getElementById('context-menu');
                menu.style.display = 'block';
                menu.style.left = `${event.pageX}px`;
                menu.style.top = `${event.pageY}px`;
            } else {
                document.getElementById('context-menu').style.display = 'none';
            }
        });

        document.addEventListener('click', () => {
            document.getElementById('context-menu').style.display = 'none';
        });

        function openReaderFromCtx() {
            if(selectedGallery) window.location.href = `/reader/${selectedGallery.id}`;
        }

        async function openEditModal() {
            if(!selectedGallery) return;
            
            // Populate Category Dropdown
            const res = await fetch('/api/categories');
            const cats = await res.json();
            const select = document.getElementById('edit_category');
            select.innerHTML = '<option value="">(None)</option>';
            cats.forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat.name;
                opt.innerText = cat.name;
                select.appendChild(opt);
            });

            // Fill Form
            const card = document.querySelector(`.card[data-id="${selectedGallery.id}"]`);
            document.getElementById('edit_id').value = selectedGallery.id;
            document.getElementById('edit_title').value = card.dataset.title;
            document.getElementById('edit_artist').value = card.dataset.artist;
            document.getElementById('edit_series').value = card.dataset.series;
            document.getElementById('edit_category').value = card.dataset.category;
            document.getElementById('edit_tags').value = card.dataset.tags;
            document.getElementById('edit_desc').value = card.dataset.desc;

            document.getElementById('edit-modal').style.display = 'flex';
        }

        function closeEditModal() {
            document.getElementById('edit-modal').style.display = 'none';
        }

        async function saveEdit() {
            const id = document.getElementById('edit_id').value;
            const payload = {
                title: document.getElementById('edit_title').value,
                artist: document.getElementById('edit_artist').value,
                series: document.getElementById('edit_series').value,
                category: document.getElementById('edit_category').value,
                tags: document.getElementById('edit_tags').value.split(',').map(t=>t.trim()),
                description: document.getElementById('edit_desc').value,
                direction: "LTR" 
            };

            await fetch(`/api/gallery/${id}/update`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            
            location.reload(); 
        }

        // Init
        loadCategoryFilters();
    </script>
{% endblock %}